<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{{ user.email }} ‚Äî Admin</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#07080a;--surface:#0d0f14;--surface2:#131720;--border:#1c2230;--border2:#252d3d;
    --text:#e2e8f5;--muted:#5a6580;--muted2:#7a8aa8;
    --accent:#3b7aff;--accent2:#5c94ff;
    --green:#22d87a;--red:#ff4e6a;--yellow:#ffb83a;--purple:#9f7aff;--cyan:#22d8d8;
    --font:'Syne',sans-serif;--mono:'JetBrains Mono',monospace;
    --sidebar:220px;--radius:14px;--radius-sm:8px;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{font-family:var(--font);background:var(--bg);color:var(--text);display:flex;min-height:100vh;}

  /* SIDEBAR */
  .sidebar{width:var(--sidebar);min-height:100vh;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;padding:24px 0;position:fixed;left:0;top:0;bottom:0;z-index:100;}
  .logo{padding:0 20px 24px;border-bottom:1px solid var(--border);margin-bottom:16px;}
  .logo-name{font-size:17px;font-weight:800;letter-spacing:-0.5px;color:var(--text);}
  .logo-name span{color:var(--accent2);}
  .logo-sub{font-size:11px;color:var(--muted);margin-top:4px;font-family:var(--mono);text-transform:uppercase;letter-spacing:1px;}
  .nav{flex:1;padding:0 12px;display:flex;flex-direction:column;gap:2px;}
  .nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:var(--radius-sm);color:var(--muted2);text-decoration:none;font-size:14px;font-weight:600;transition:all .15s;position:relative;}
  .nav-item:hover{background:var(--surface2);color:var(--text);}
  .nav-item.active{background:rgba(59,122,255,.12);color:var(--accent2);}
  .nav-item.active::before{content:'';position:absolute;left:0;top:20%;bottom:20%;width:3px;background:var(--accent);border-radius:0 3px 3px 0;}
  .nav-icon{font-size:16px;width:20px;text-align:center;}
  .sidebar-footer{padding:16px 12px 0;border-top:1px solid var(--border);}
  .admin-label{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--muted);padding:8px 12px;font-family:var(--mono);}
  .admin-dot{width:7px;height:7px;background:var(--green);border-radius:50%;}
  .logout-btn{width:100%;background:transparent;border:1px solid var(--border2);color:var(--muted2);padding:9px 12px;border-radius:var(--radius-sm);font-size:13px;font-weight:600;cursor:pointer;font-family:var(--font);transition:all .15s;margin-top:8px;}
  .logout-btn:hover{background:var(--red);border-color:var(--red);color:#fff;}

  /* MAIN */
  .main{margin-left:var(--sidebar);flex:1;min-height:100vh;display:flex;flex-direction:column;}
  .topbar{height:60px;border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 28px;gap:12px;background:var(--surface);position:sticky;top:0;z-index:50;}
  .topbar-back{color:var(--muted2);text-decoration:none;font-size:13px;font-weight:600;display:flex;align-items:center;gap:6px;padding:6px 10px;border-radius:var(--radius-sm);border:1px solid var(--border2);transition:all .15s;}
  .topbar-back:hover{background:var(--surface2);color:var(--text);}
  .topbar-title{font-size:16px;font-weight:800;letter-spacing:-0.3px;}
  .topbar-right{margin-left:auto;display:flex;align-items:center;gap:8px;}
  .content{padding:24px 28px;flex:1;}

  /* LAYOUT */
  .layout{display:grid;grid-template-columns:340px 1fr;gap:20px;align-items:start;}
  .left-col{display:flex;flex-direction:column;gap:16px;}
  .right-col{display:flex;flex-direction:column;gap:16px;}

  /* CARDS */
  .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;}
  .card-header{padding:14px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
  .card-title{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--muted);font-family:var(--mono);}
  .card-body{padding:18px;}
  .card-body-compact{padding:4px 0;}

  /* USER HERO */
  .user-hero{padding:20px 18px;display:flex;flex-direction:column;align-items:center;text-align:center;gap:10px;border-bottom:1px solid var(--border);}
  .user-avatar{width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--purple));display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:800;color:#fff;}
  .user-email-main{font-size:15px;font-weight:700;word-break:break-all;}
  .user-id-badge{font-family:var(--mono);font-size:11px;color:var(--muted);background:var(--surface2);border:1px solid var(--border2);padding:2px 8px;border-radius:20px;}

  /* INFO ROWS */
  .info-row{display:flex;align-items:center;justify-content:space-between;padding:10px 18px;border-bottom:1px solid var(--border);gap:12px;}
  .info-row:last-child{border-bottom:none;}
  .info-label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--muted);font-family:var(--mono);white-space:nowrap;flex-shrink:0;}
  .info-value{font-size:13px;text-align:right;word-break:break-all;}

  /* BADGES */
  .badge{display:inline-flex;align-items:center;gap:5px;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:600;font-family:var(--mono);}
  .badge::before{content:'';width:5px;height:5px;border-radius:50%;}
  .badge-green{background:rgba(34,216,122,.1);color:var(--green);border:1px solid rgba(34,216,122,.2);}
  .badge-green::before{background:var(--green);}
  .badge-red{background:rgba(255,78,106,.1);color:var(--red);border:1px solid rgba(255,78,106,.2);}
  .badge-red::before{background:var(--red);}
  .badge-yellow{background:rgba(255,184,58,.1);color:var(--yellow);border:1px solid rgba(255,184,58,.2);}
  .badge-yellow::before{background:var(--yellow);}
  .badge-blue{background:rgba(59,122,255,.1);color:var(--accent2);border:1px solid rgba(59,122,255,.2);}
  .badge-blue::before{background:var(--accent);}

  /* BUTTONS */
  .btn{display:inline-flex;align-items:center;gap:6px;padding:8px 14px;border-radius:var(--radius-sm);font-size:12px;font-weight:700;cursor:pointer;border:none;font-family:var(--font);transition:all .15s;text-decoration:none;white-space:nowrap;}
  .btn-primary{background:var(--accent);color:#fff;}
  .btn-primary:hover{background:var(--accent2);}
  .btn-ghost{background:transparent;border:1px solid var(--border2);color:var(--muted2);}
  .btn-ghost:hover{background:var(--surface2);color:var(--text);}
  .btn-danger{background:rgba(255,78,106,.1);color:var(--red);border:1px solid rgba(255,78,106,.2);}
  .btn-danger:hover{background:var(--red);color:#fff;border-color:var(--red);}
  .btn-success{background:rgba(34,216,122,.1);color:var(--green);border:1px solid rgba(34,216,122,.2);}
  .btn-success:hover{background:var(--green);color:#000;}
  .btn-warn{background:rgba(255,184,58,.1);color:var(--yellow);border:1px solid rgba(255,184,58,.2);}
  .btn-warn:hover{background:var(--yellow);color:#000;}
  .btn-sm{padding:5px 10px;font-size:11px;}
  .btn-full{width:100%;justify-content:center;}
  .btn-group{display:flex;flex-direction:column;gap:6px;padding:14px 18px;}
  .btn-group-h{display:flex;gap:6px;flex-wrap:wrap;padding:14px 18px;}

  /* BALANCE */
  .balance-display{padding:18px;text-align:center;}
  .balance-amount{font-size:36px;font-weight:800;color:var(--green);letter-spacing:-1.5px;line-height:1;}
  .balance-label{font-size:11px;color:var(--muted);font-family:var(--mono);text-transform:uppercase;letter-spacing:.8px;margin-top:6px;}
  .balance-sub{font-size:12px;color:var(--muted2);margin-top:4px;font-family:var(--mono);}

  /* LICENSE BLOCK */
  .lic-key{font-family:var(--mono);font-size:13px;font-weight:600;color:var(--accent2);background:var(--surface2);border:1px solid var(--border2);padding:8px 12px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:12px;}

  /* DEVICES */
  .device-row{display:flex;align-items:center;gap:12px;padding:11px 18px;border-bottom:1px solid var(--border);}
  .device-row:last-child{border-bottom:none;}
  .device-icon{width:34px;height:34px;background:var(--surface2);border:1px solid var(--border2);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;}
  .device-info{flex:1;min-width:0;}
  .device-name{font-size:13px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
  .device-fp{font-family:var(--mono);font-size:10px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-top:2px;}
  .device-meta{font-size:10px;color:var(--muted2);margin-top:1px;}

  /* LIMIT STEPPER */
  .limit-cell{display:flex;align-items:center;gap:6px;}
  .limit-stepper{display:flex;flex-direction:column;gap:2px;}
  .step-btn{width:18px;height:12px;background:var(--surface2);border:1px solid var(--border2);border-radius:2px;cursor:pointer;color:var(--muted2);font-size:9px;display:flex;align-items:center;justify-content:center;transition:all .12s;}
  .step-btn:hover{background:var(--accent);border-color:var(--accent);color:#fff;}
  .limit-val{font-family:var(--mono);font-size:14px;font-weight:700;min-width:24px;text-align:center;}
  .limit-save-btn{padding:3px 8px;background:rgba(34,216,122,.1);border:1px solid rgba(34,216,122,.2);border-radius:5px;color:var(--green);cursor:pointer;font-size:11px;font-weight:700;font-family:var(--font);transition:all .15s;display:none;}
  .limit-save-btn.show{display:inline-flex;align-items:center;gap:4px;}
  .limit-save-btn:hover{background:var(--green);color:#000;}

  /* TRANSACTIONS TABLE */
  .tx-table{width:100%;border-collapse:collapse;font-size:12px;}
  .tx-table th{padding:8px 14px;text-align:left;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--muted);font-family:var(--mono);border-bottom:1px solid var(--border);background:var(--surface2);}
  .tx-table td{padding:9px 14px;border-bottom:1px solid var(--border);vertical-align:middle;}
  .tx-table tr:last-child td{border-bottom:none;}
  .tx-table tr:hover td{background:rgba(19,23,32,.6);}
  .amount-pos{color:var(--green);font-family:var(--mono);font-weight:700;}
  .amount-neg{color:var(--red);font-family:var(--mono);font-weight:700;}
  .mono{font-family:var(--mono);font-size:11px;}
  .text-muted{color:var(--muted2);}

  /* FORM ELEMENTS */
  .form-group{display:flex;flex-direction:column;gap:5px;margin-bottom:12px;}
  .form-group:last-child{margin-bottom:0;}
  .form-label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--muted);font-family:var(--mono);}
  .form-input,.form-select{background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);padding:9px 12px;color:var(--text);font-size:13px;font-family:var(--font);outline:none;transition:border-color .15s;width:100%;}
  .form-input:focus,.form-select:focus{border-color:var(--accent);}
  .form-input::placeholder{color:var(--muted);}
  .form-select option{background:var(--surface2);}
  .form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}

  /* MODAL */
  .modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(4px);z-index:1000;align-items:center;justify-content:center;}
  .modal-bg.open{display:flex;}
  .modal{background:var(--surface);border:1px solid var(--border2);border-radius:var(--radius);padding:26px;width:400px;max-width:96vw;animation:slideUp .2s ease;}
  @keyframes slideUp{from{opacity:0;transform:translateY(16px);}to{opacity:1;transform:translateY(0);}}
  .modal-title{font-size:15px;font-weight:800;margin-bottom:4px;}
  .modal-sub{font-size:12px;color:var(--muted2);margin-bottom:18px;}
  .modal-footer{display:flex;gap:8px;justify-content:flex-end;margin-top:16px;}

  /* COPY */
  .copy-btn{background:none;border:none;cursor:pointer;color:var(--muted);font-size:12px;padding:2px 5px;border-radius:4px;transition:color .15s;flex-shrink:0;}
  .copy-btn:hover{color:var(--accent2);}

  /* TOAST */
  .toast-wrap{position:fixed;bottom:24px;right:24px;z-index:2000;display:flex;flex-direction:column;gap:8px;}
  .toast{background:var(--surface);border:1px solid var(--border2);border-radius:var(--radius-sm);padding:11px 16px;font-size:13px;font-weight:600;display:flex;align-items:center;gap:8px;animation:toastIn .2s ease;min-width:220px;box-shadow:0 8px 24px rgba(0,0,0,.4);}
  .toast.ok{border-color:rgba(34,216,122,.3);}
  .toast.err{border-color:rgba(255,78,106,.3);}
  @keyframes toastIn{from{opacity:0;transform:translateX(16px);}to{opacity:1;transform:translateX(0);}}
  ::-webkit-scrollbar{width:6px;height:6px;}::-webkit-scrollbar-track{background:transparent;}::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px;}

  /* EMPTY */
  .empty-state{padding:28px;text-align:center;color:var(--muted);font-size:13px;}
  .empty-icon{font-size:28px;margin-bottom:8px;opacity:.5;}

  /* SECTION DIVIDER */
  .section-sep{height:1px;background:var(--border);margin:0;}

  /* USAGE LOG */
  .usage-row{display:flex;align-items:center;justify-content:space-between;padding:9px 18px;border-bottom:1px solid var(--border);font-size:12px;}
  .usage-row:last-child{border-bottom:none;}
  .usage-op{font-family:var(--mono);color:var(--cyan);font-size:11px;}
  .usage-cost{font-family:var(--mono);color:var(--red);font-weight:700;}
</style>
</head>
<body>

{% set uid = user.id %}
{% set user_key = user.license_key or '' %}

<div class="sidebar">
  <div class="logo">
    <div class="logo-name"><span>TG</span> Parser Sender</div>
    <div class="logo-sub">Admin Panel</div>
  </div>
  <nav class="nav">
    <a href="/admin" class="nav-item {% if active_tab == 'dashboard' %}active{% endif %}"><span class="nav-icon">‚óà</span> –î–∞—à–±–æ—Ä–¥</a>
    <a href="/admin/licenses" class="nav-item {% if active_tab == 'licenses' %}active{% endif %}"><span class="nav-icon">‚åó</span> –õ–∏—Ü–µ–Ω–∑–∏–∏</a>
    <a href="/admin/users" class="nav-item {% if active_tab == 'users' %}active{% endif %}"><span class="nav-icon">‚óâ</span> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
    <a href="/admin/devices" class="nav-item {% if active_tab == 'devices' %}active{% endif %}"><span class="nav-icon">‚äü</span> –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</a>
    <a href="/admin/transactions" class="nav-item {% if active_tab == 'transactions' %}active{% endif %}"><span class="nav-icon">‚âã</span> –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</a>
    <a href="/admin/settings" class="nav-item {% if active_tab == 'settings' %}active{% endif %}"><span class="nav-icon">‚åò</span> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
  </nav>
  <div class="sidebar-footer">
    <div class="admin-label"><span class="admin-dot"></span>admin online</div>
    <form method="post" action="/admin/logout"><button class="logout-btn">‚Ü© –í—ã–π—Ç–∏</button></form>
  </div>
</div>

<div class="main">
  <div class="topbar">
    <a href="/admin/users" class="topbar-back">‚Üê –ù–∞–∑–∞–¥</a>
    <span class="topbar-title">{{ user.email }}</span>
    <div class="topbar-right">
      {% if user.email_confirmed %}
        <span class="badge badge-green">Email ‚úì</span>
      {% else %}
        <span class="badge badge-yellow">Email –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω</span>
      {% endif %}
      {% if user.is_active %}
        <span class="badge badge-green">–ê–∫—Ç–∏–≤–µ–Ω</span>
      {% else %}
        <span class="badge badge-red">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</span>
      {% endif %}
    </div>
  </div>

  <div class="content">
    <div class="layout">

      <!-- ========== LEFT COL ========== -->
      <div class="left-col">

        <!-- USER INFO CARD -->
        <div class="card">
          <div class="user-hero">
            <div class="user-avatar">{{ user.email[0].upper() }}</div>
            <div class="user-email-main">{{ user.email }}</div>
            <div class="user-id-badge">id: {{ user.id }}</div>
          </div>

          <div class="info-row">
            <span class="info-label">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω</span>
            <span class="info-value mono text-muted">{{ user.created_at.strftime('%d.%m.%Y %H:%M') if user.created_at else '‚Äî' }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥</span>
            <span class="info-value mono text-muted">{{ user.last_login.strftime('%d.%m.%Y %H:%M') if user.last_login else '‚Äî' }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ</span>
            <span class="info-value mono" style="color:var(--red);">${{ "%.2f"|format(user.total_spent or 0) }}</span>
          </div>

          <!-- ACTIONS -->
          <div class="btn-group">
            {% if not user.email_confirmed %}
            <button class="btn btn-success btn-sm btn-full" onclick="confirmEmail()">‚úì –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å email</button>
            {% endif %}
            <button class="btn btn-warn btn-sm btn-full" onclick="openModal('resetPwdModal')">üîë –°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
            <button class="btn btn-ghost btn-sm btn-full" onclick="openModal('changeEmailModal')">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å email</button>
            <button class="btn btn-danger btn-sm btn-full" onclick="unlinkAllDevices()">üìµ –û—Ç–≤—è–∑–∞—Ç—å –≤—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</button>
          </div>
        </div>

        <!-- BALANCE CARD -->
        <div class="card">
          <div class="card-header">
            <span class="card-title">–ë–∞–ª–∞–Ω—Å</span>
          </div>
          <div class="balance-display">
            <div class="balance-amount" id="balanceDisplay">${{ "%.2f"|format(user.balance or 0) }}</div>
            <div class="balance-label">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</div>
            <div class="balance-sub">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ: ${{ "%.2f"|format(user.total_spent or 0) }}</div>
          </div>
          <div style="padding:0 18px 14px;display:flex;gap:8px;">
            <button class="btn btn-success btn-sm" style="flex:1;justify-content:center;" onclick="openModal('addBalanceModal')">+ –ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
            <button class="btn btn-ghost btn-sm" style="flex:1;justify-content:center;" onclick="openModal('setBalanceModal')">‚úèÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
          </div>
        </div>

        <!-- LICENSE CARD -->
        <div class="card">
          <div class="card-header">
            <span class="card-title">–õ–∏—Ü–µ–Ω–∑–∏—è</span>
            {% if user_key %}
              {% if user.license_revoked %}
                <span class="badge badge-red">–ó–∞–±–ª–æ–∫.</span>
              {% elif now > user.license_expires %}
                <span class="badge badge-yellow">–ò—Å—Ç–µ–∫–ª–∞</span>
              {% else %}
                <span class="badge badge-green">–ê–∫—Ç–∏–≤–Ω–∞</span>
              {% endif %}
            {% endif %}
          </div>
          <div class="card-body">
            {% if user_key %}
            <div class="lic-key">
              <span>{{ user_key }}</span>
              <button class="copy-btn" onclick="copyText('{{ user_key }}')">‚éò</button>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px;">
              <div style="background:var(--surface2);border:1px solid var(--border2);border-radius:8px;padding:10px;text-align:center;">
                <div style="font-size:11px;color:var(--muted);font-family:var(--mono);text-transform:uppercase;letter-spacing:.6px;">–ò—Å—Ç–µ–∫–∞–µ—Ç</div>
                <div style="font-size:13px;font-weight:700;margin-top:4px;
                  {% if now > user.license_expires %}color:var(--red);
                  {% elif (user.license_expires - now).days < 7 %}color:var(--yellow);
                  {% else %}color:var(--green);{% endif %}">
                  {{ user.license_expires.strftime('%d.%m.%Y') if user.license_expires else '‚Äî' }}
                </div>
              </div>
              <div style="background:var(--surface2);border:1px solid var(--border2);border-radius:8px;padding:10px;text-align:center;">
                <div style="font-size:11px;color:var(--muted);font-family:var(--mono);text-transform:uppercase;letter-spacing:.6px;">–õ–∏–º–∏—Ç</div>
                <div style="display:flex;align-items:center;justify-content:center;gap:6px;margin-top:4px;">
                  <div class="limit-stepper">
                    <button class="step-btn" onclick="stepLimit(1)">‚ñ≤</button>
                    <button class="step-btn" onclick="stepLimit(-1)">‚ñº</button>
                  </div>
                  <span class="limit-val" id="limitVal">{{ user.max_devices or 1 }}</span>
                  <span style="font-size:11px;color:var(--muted);">–¥–µ–≤.</span>
                </div>
              </div>
            </div>
            <div style="display:flex;gap:8px;">
              <button class="btn btn-primary btn-sm" style="flex:1;justify-content:center;" onclick="openModal('extendModal')">+ –ü—Ä–æ–¥–ª–∏—Ç—å</button>
              <button class="limit-save-btn" id="limitSaveBtn" onclick="saveLimit()">‚úì –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
            {% else %}
            <div class="empty-state">
              <div class="empty-icon">üîë</div>
              –õ–∏—Ü–µ–Ω–∑–∏—è –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω–∞
            </div>
            {% endif %}
          </div>
        </div>

      </div><!-- /left-col -->

      <!-- ========== RIGHT COL ========== -->
      <div class="right-col">

        <!-- DEVICES CARD -->
        <div class="card">
          <div class="card-header">
            <span class="card-title">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ ({{ devices|length }})</span>
            <button class="btn btn-danger btn-sm" onclick="unlinkAllDevices()" {% if not devices %}disabled{% endif %}>üìµ –û—Ç–≤—è–∑–∞—Ç—å –≤—Å–µ</button>
          </div>
          <div class="card-body-compact">
            {% for d in devices %}
            <div class="device-row">
              <div class="device-icon">{% if d.is_active %}üíª{% else %}üö´{% endif %}</div>
              <div class="device-info">
                <div class="device-name">{{ d.device_name or '–ë–µ–∑ –∏–º–µ–Ω–∏' }}</div>
                <div class="device-fp" title="{{ d.device_fingerprint }}">{{ d.device_fingerprint }}</div>
                <div class="device-meta">
                  {% if d.last_login %}{{ d.last_login.strftime('%d.%m.%Y %H:%M') }}{% else %}‚Äî{% endif %}
                  {% if d.last_ip %} ¬∑ {{ d.last_ip }}{% endif %}
                </div>
              </div>
              {% if d.is_active %}
                <span class="badge badge-green" style="font-size:10px;">Online</span>
              {% else %}
                <span class="badge badge-red" style="font-size:10px;">Off</span>
              {% endif %}
              <button class="btn btn-danger btn-sm" onclick="unlinkDevice({{ d.id }}, '{{ d.device_name or '—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ' }}')">‚úï</button>
            </div>
            {% else %}
            <div class="empty-state"><div class="empty-icon">üíª</div>–£—Å—Ç—Ä–æ–π—Å—Ç–≤ –Ω–µ—Ç</div>
            {% endfor %}
          </div>
        </div>

        <!-- TRANSACTIONS CARD -->
        <div class="card">
          <div class="card-header">
            <span class="card-title">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ ({{ transactions|length }})</span>
            <button class="btn btn-success btn-sm" onclick="openModal('addBalanceModal')">+ –ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
          </div>
          <div style="overflow-x:auto;">
            <table class="tx-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>–¢–∏–ø</th>
                  <th>–°—É–º–º–∞</th>
                  <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                  <th>–î–∞—Ç–∞</th>
                </tr>
              </thead>
              <tbody>
                {% for t in transactions %}
                <tr>
                  <td class="mono text-muted">#{{ t.id }}</td>
                  <td>
                    {% if t.type == 'deposit' %}<span class="badge badge-green" style="font-size:10px;">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</span>
                    {% elif t.type == 'spend' %}<span class="badge badge-red" style="font-size:10px;">–°–ø–∏—Å–∞–Ω–∏–µ</span>
                    {% elif t.type == 'refund' %}<span class="badge badge-yellow" style="font-size:10px;">–í–æ–∑–≤—Ä–∞—Ç</span>
                    {% else %}<span class="mono text-muted">{{ t.type }}</span>{% endif %}
                  </td>
                  <td>
                    {% if t.amount >= 0 %}<span class="amount-pos">+${{ "%.4f"|format(t.amount) }}</span>
                    {% else %}<span class="amount-neg">-${{ "%.4f"|format(t.amount|abs) }}</span>{% endif %}
                  </td>
                  <td class="text-muted" style="font-size:12px;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">{{ t.description or '‚Äî' }}</td>
                  <td class="mono text-muted">{{ t.created_at.strftime('%d.%m.%y %H:%M') if t.created_at else '‚Äî' }}</td>
                </tr>
                {% else %}
                <tr><td colspan="5" class="empty-state">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –Ω–µ—Ç</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- USAGE LOGS -->
        {% if usage_logs %}
        <div class="card">
          <div class="card-header">
            <span class="card-title">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ ({{ usage_logs|length }})</span>
          </div>
          <div class="card-body-compact">
            {% for u in usage_logs %}
            <div class="usage-row">
              <span class="usage-op">{{ u.operation_type }}</span>
              <span class="mono text-muted">{{ u.units_used }} –µ–¥.</span>
              <span class="usage-cost">-${{ "%.4f"|format(u.cost) }}</span>
              <span class="mono text-muted">{{ u.created_at.strftime('%d.%m.%y') if u.created_at else '‚Äî' }}</span>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}

      </div><!-- /right-col -->
    </div>
  </div>
</div>

<!-- ============ MODALS ============ -->

<!-- ADD BALANCE -->
<div class="modal-bg" id="addBalanceModal">
  <div class="modal">
    <div class="modal-title">üí∞ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</div>
    <div class="modal-sub">{{ user.email }}</div>
    <div class="form-group">
      <label class="form-label">–°—É–º–º–∞ ($)</label>
      <input type="number" class="form-input" id="depositAmount" step="0.01" min="0.01" placeholder="10.00">
    </div>
    <div class="form-group">
      <label class="form-label">–ú–µ—Ç–æ–¥</label>
      <select class="form-select" id="depositMethod">
        <option value="manual">–†—É—á–Ω–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</option>
        <option value="crypto">–ö—Ä–∏–ø—Ç–∞</option>
        <option value="card">–ö–∞—Ä—Ç–∞</option>
        <option value="other">–î—Ä—É–≥–æ–µ</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">–ó–∞–º–µ—Ç–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
      <input type="text" class="form-input" id="depositNote" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –æ–ø–ª–∞—Ç–∞ –∑–∞ –Ω–æ—è–±—Ä—å">
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost btn-sm" onclick="closeModal('addBalanceModal')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-success btn-sm" onclick="addBalance()">+ –ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- SET BALANCE -->
<div class="modal-bg" id="setBalanceModal">
  <div class="modal">
    <div class="modal-title">‚úèÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å</div>
    <div class="modal-sub">–¢–µ–∫—É—â–∏–π: <strong id="currentBalDisp">${{ "%.2f"|format(user.balance or 0) }}</strong></div>
    <div class="form-group">
      <label class="form-label">–ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å ($)</label>
      <input type="number" class="form-input" id="newBalanceVal" step="0.01" min="0" value="{{ "%.2f"|format(user.balance or 0) }}">
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost btn-sm" onclick="closeModal('setBalanceModal')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary btn-sm" onclick="setBalance()">‚úì –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- EXTEND LICENSE -->
<div class="modal-bg" id="extendModal">
  <div class="modal">
    <div class="modal-title">üìÖ –ü—Ä–æ–¥–ª–∏—Ç—å –ª–∏—Ü–µ–Ω–∑–∏—é</div>
    <div class="modal-sub">–ö–ª—é—á: <strong>{{ user_key or '‚Äî' }}</strong></div>
    <div class="form-group">
      <label class="form-label">–î–æ–±–∞–≤–∏—Ç—å –¥–Ω–µ–π</label>
      <input type="number" class="form-input" id="extendDays" value="30" min="1" max="3650">
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost btn-sm" onclick="closeModal('extendModal')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary btn-sm" onclick="extendLicense()">‚úì –ü—Ä–æ–¥–ª–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- RESET PASSWORD -->
<div class="modal-bg" id="resetPwdModal">
  <div class="modal">
    <div class="modal-title">üîë –°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è</div>
    <div class="modal-sub">–ü–∏—Å—å–º–æ —Å–æ —Å—Å—ã–ª–∫–æ–π –¥–ª—è —Å–±—Ä–æ—Å–∞ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞<br><strong>{{ user.email }}</strong></div>
    <div class="modal-footer">
      <button class="btn btn-ghost btn-sm" onclick="closeModal('resetPwdModal')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-warn btn-sm" onclick="resetPassword()">üìß –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ</button>
    </div>
  </div>
</div>

<!-- CHANGE EMAIL -->
<div class="modal-bg" id="changeEmailModal">
  <div class="modal">
    <div class="modal-title">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å email</div>
    <div class="modal-sub">–¢–µ–∫—É—â–∏–π: <strong>{{ user.email }}</strong></div>
    <div class="form-group">
      <label class="form-label">–ù–æ–≤—ã–π email</label>
      <input type="email" class="form-input" id="newEmail" placeholder="new@example.com">
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost btn-sm" onclick="closeModal('changeEmailModal')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary btn-sm" onclick="changeEmail()">‚úì –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<div class="toast-wrap" id="toasts"></div>

<script>
  const USER_ID = {{ user.id }};
  const USER_KEY = "{{ user_key }}";
  const USER_EMAIL = "{{ user.email }}";
  let limitOriginal = {{ user.max_devices or 1 }};
  let limitCurrent = {{ user.max_devices or 1 }};

  // ===== LIMIT STEPPER =====
  function stepLimit(delta) {
    limitCurrent = Math.max(1, Math.min(99, limitCurrent + delta));
    document.getElementById('limitVal').textContent = limitCurrent;
    const btn = document.getElementById('limitSaveBtn');
    if (limitCurrent !== limitOriginal) btn.classList.add('show');
    else btn.classList.remove('show');
  }

  async function saveLimit() {
    const btn = document.getElementById('limitSaveBtn');
    btn.textContent = '...';
    const ok = await api('/admin/api/update-limit', { key: USER_KEY, max_devices: limitCurrent });
    if (ok) { limitOriginal = limitCurrent; btn.classList.remove('show'); showToast('‚úì –õ–∏–º–∏—Ç: ' + limitCurrent + ' –¥–µ–≤.', 'ok'); }
    else btn.textContent = '‚úì –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
  }

  // ===== BALANCE =====
  async function addBalance() {
    const amount = parseFloat(document.getElementById('depositAmount').value);
    const method = document.getElementById('depositMethod').value;
    const note = document.getElementById('depositNote').value;
    if (!amount || amount <= 0) return showToast('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É', 'err');
    const res = await apiRaw('/admin/api/deposit', { user_id: USER_ID, amount, method, note });
    if (res && res.success) {
      closeModal('addBalanceModal');
      document.getElementById('balanceDisplay').textContent = '$' + parseFloat(res.new_balance).toFixed(2);
      document.getElementById('currentBalDisp').textContent = '$' + parseFloat(res.new_balance).toFixed(2);
      document.getElementById('newBalanceVal').value = parseFloat(res.new_balance).toFixed(2);
      showToast('‚úì –ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ $' + amount.toFixed(2), 'ok');
    }
  }

  async function setBalance() {
    const balance = parseFloat(document.getElementById('newBalanceVal').value);
    if (isNaN(balance)) return showToast('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É', 'err');
    const ok = await api('/admin/api/set-balance', { user_id: USER_ID, balance });
    if (ok) {
      closeModal('setBalanceModal');
      document.getElementById('balanceDisplay').textContent = '$' + balance.toFixed(2);
      showToast('‚úì –ë–∞–ª–∞–Ω—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: $' + balance.toFixed(2), 'ok');
    }
  }

  // ===== LICENSE =====
  async function extendLicense() {
    const days = parseInt(document.getElementById('extendDays').value);
    if (!days || days < 1) return showToast('–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π', 'err');
    const ok = await api('/admin/api/extend-license', { key: USER_KEY, days });
    if (ok) { closeModal('extendModal'); showToast('‚úì –õ–∏—Ü–µ–Ω–∑–∏—è –ø—Ä–æ–¥–ª–µ–Ω–∞ –Ω–∞ ' + days + ' –¥–Ω.', 'ok'); setTimeout(()=>location.reload(), 1000); }
  }

  // ===== DEVICES =====
  async function unlinkDevice(id, name) {
    if (!confirm('–û—Ç–≤—è–∑–∞—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ "' + name + '"?')) return;
    const ok = await api('/admin/api/unlink-device', { device_id: id });
    if (ok) { showToast('‚úì –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ—Ç–≤—è–∑–∞–Ω–æ', 'ok'); setTimeout(()=>location.reload(), 800); }
  }

  async function unlinkAllDevices() {
    if (!confirm('–û—Ç–≤—è–∑–∞—Ç—å –í–°–ï —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞?\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—É–¥–µ—Ç –≤—ã–±—Ä–æ—à–µ–Ω –∏–∑ –≤—Å–µ—Ö —Å–µ—Å—Å–∏–π.')) return;
    const ok = await api('/admin/api/unlink-devices', { user_id: USER_ID });
    if (ok) { showToast('‚úì –í—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –æ—Ç–≤—è–∑–∞–Ω—ã', 'ok'); setTimeout(()=>location.reload(), 800); }
  }

  // ===== EMAIL =====
  async function confirmEmail() {
    const ok = await api('/admin/api/confirm-email', { user_id: USER_ID });
    if (ok) { showToast('‚úì Email –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω', 'ok'); setTimeout(()=>location.reload(), 800); }
  }

  async function resetPassword() {
    const ok = await api('/admin/api/reset-password', { user_id: USER_ID, email: USER_EMAIL });
    if (ok) { closeModal('resetPwdModal'); showToast('üìß –ü–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'ok'); }
  }

  async function changeEmail() {
    const email = document.getElementById('newEmail').value.trim();
    if (!email) return showToast('–í–≤–µ–¥–∏—Ç–µ email', 'err');
    const ok = await api('/admin/api/update-email', { user_id: USER_ID, email });
    if (ok) { closeModal('changeEmailModal'); showToast('‚úì Email –∏–∑–º–µ–Ω—ë–Ω', 'ok'); setTimeout(()=>location.reload(), 800); }
  }

  // ===== HELPERS =====
  async function api(url, body) {
    try {
      const res = await fetch(url, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
      const d = await res.json();
      if (d.success) return true;
      showToast('–û—à–∏–±–∫–∞: ' + (d.detail || d.error || '?'), 'err');
      return false;
    } catch(e) { showToast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'err'); return false; }
  }

  async function apiRaw(url, body) {
    try {
      const res = await fetch(url, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
      const d = await res.json();
      if (!d.success) { showToast('–û—à–∏–±–∫–∞: ' + (d.detail || d.error || '?'), 'err'); return null; }
      return d;
    } catch(e) { showToast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'err'); return null; }
  }

  function openModal(id) { document.getElementById(id).classList.add('open'); }
  function closeModal(id) { document.getElementById(id).classList.remove('open'); }
  document.querySelectorAll('.modal-bg').forEach(m => m.addEventListener('click', e => { if(e.target===m) m.classList.remove('open'); }));

  function copyText(t) { navigator.clipboard.writeText(t).then(()=>showToast('‚éò –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ', 'ok')); }

  function showToast(msg, type='ok') {
    const w = document.getElementById('toasts');
    const t = document.createElement('div');
    t.className = 'toast ' + type;
    t.textContent = msg;
    w.appendChild(t);
    setTimeout(()=>t.remove(), 3000);
  }
</script>
</body>
</html>
