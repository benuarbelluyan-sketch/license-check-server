<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Licenses Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b0f19; color:#e6e8ee; }
    .wrap { max-width: 1280px; margin: 24px auto; padding: 0 16px; }
    .top { display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .card { background:#121a2a; border:1px solid #1f2a44; border-radius:16px; padding:16px; margin-top:14px; }
    input, select { padding:10px 12px; border-radius:10px; border:1px solid #2a3a5f; background:#0b1322; color:#e6e8ee; }
    button { padding:10px 12px; border:0; border-radius:10px; background:#3b82f6; color:white; font-weight:700; cursor:pointer; }
    .btn2 { background:#334155; }
    .danger { background:#ef4444; }
    .okbtn { background:#22c55e; }
    table { width:100%; border-collapse: collapse; margin-top:10px; }
    th, td { text-align:left; padding:10px 8px; border-bottom:1px solid #1f2a44; font-size:14px; vertical-align:top; }
    .tag { display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; border:1px solid #2a3a5f; }
    .active { color:#7CFFB2; }
    .revoked { color:#ff7b7b; }
    .expired { color:#ffd37b; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    .grid { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .stats-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap:12px; margin-bottom:20px; }
    .stat { padding:16px; border-radius:14px; background:#0b1322; border:1px solid #1f2a44; text-align:center; }
    .stat-value { font-size:28px; font-weight:bold; line-height:1.2; }
    .stat-label { color:#9aa4b2; font-size:13px; margin-top:4px; }
    .stat-small { font-size:14px; color:#7c8aa0; margin-top:4px; }
    .row-actions form { display:inline; margin-right:6px; }
    a { color:#93c5fd; text-decoration:none; }
    .section-title { font-size:18px; font-weight:600; margin:20px 0 10px 0; color:#fff; }
  </style>
</head>
<body>
<div class="wrap">

  <div class="top">
    <div>
      <h2 style="margin:0;">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –ª–∏—Ü–µ–Ω–∑–∏–π</h2>
      <div style="color:#9aa4b2; font-size:13px;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏—Ü–µ–Ω–∑–∏—è–º–∏, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏</div>
    </div>

    <form method="post" action="/admin/logout">
      <button class="btn2" type="submit">–í—ã–π—Ç–∏</button>
    </form>
  </div>

  <!-- ========== –ù–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê ========== -->
  <div class="stats-grid">
    <!-- –õ–∏—Ü–µ–Ω–∑–∏–∏ -->
    <div class="stat">
      <div class="stat-value">{{ stats.total }}</div>
      <div class="stat-label">–í—Å–µ–≥–æ –ª–∏—Ü–µ–Ω–∑–∏–π</div>
      <div class="stat-small">
        <span class="active">{{ stats.active }}</span> –∞–∫—Ç–∏–≤–Ω—ã—Ö |
        <span class="expired">{{ stats.expired }}</span> –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ |
        <span class="revoked">{{ stats.revoked }}</span> –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ
      </div>
    </div>
    
    <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
    <div class="stat">
      <div class="stat-value">{{ stats.total_users }}</div>
      <div class="stat-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
      <div class="stat-small">
        <span style="color:#7CFFB2;">{{ stats.confirmed_users }}</span> –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª–∏ email
      </div>
    </div>
    
    <!-- –ë–∞–ª–∞–Ω—Å -->
    <div class="stat">
      <div class="stat-value">${{ "%.2f"|format(stats.total_balance) }}</div>
      <div class="stat-label">–ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
      <div class="stat-small">
        –≤—Å–µ–≥–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ: ${{ "%.2f"|format(stats.total_revenue) }}
      </div>
    </div>
    
    <!-- –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ -->
    <div class="stat">
      <div class="stat-value">{{ stats.total_devices }}</div>
      <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤</div>
      <div class="stat-small">
        —É {{ stats.users_with_devices }} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
      </div>
    </div>
  </div>

  <div class="card">
    <div class="grid">
      <form method="get" action="/admin" class="grid">
        <input name="q" value="{{ q }}" placeholder="–ø–æ–∏—Å–∫: key / hwid / note" style="min-width:260px;">
        <select name="status">
          <option value="all" {% if status=="all" %}selected{% endif %}>–í—Å–µ</option>
          <option value="active" {% if status=="active" %}selected{% endif %}>Active</option>
          <option value="expired" {% if status=="expired" %}selected{% endif %}>Expired</option>
          <option value="revoked" {% if status=="revoked" %}selected{% endif %}>Revoked</option>
        </select>
        <button type="submit">–ù–∞–π—Ç–∏</button>
      </form>

      <a href="/admin/export.csv?status={{ status }}" style="margin-left:auto;">
        <button type="button" class="btn2">Export CSV</button>
      </a>
    </div>
  </div>

  <div class="card">
    <h3 style="margin-top:0;">–°–æ–∑–¥–∞—Ç—å / –ø—Ä–æ–¥–ª–∏—Ç—å –ª–∏—Ü–µ–Ω–∑–∏—é</h3>

    <form method="post" action="/admin/upsert">
      <div class="grid">
        <input name="key" placeholder="KEY (–Ω–∞–ø—Ä–∏–º–µ—Ä MY-PC-001)" required style="min-width:220px;">
        <input name="hwid" placeholder="HWID (UUID –∫–ª–∏–µ–Ω—Ç–∞)" required style="min-width:320px;">
        <input name="days" placeholder="days" required value="30" style="width:90px;">
        <select name="plan">
          <option value="custom">custom</option>
          <option value="m1">m1 (1 —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ)</option>
          <option value="m3">m3 (2 —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞)</option>
          <option value="m6">m6 (3 —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞)</option>
          <option value="y1">y1 (5 —É—Å—Ç—Ä–æ–π—Å—Ç–≤)</option>
        </select>
        <input name="note" placeholder="note (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" style="min-width:220px;">
        <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </form>

    <div style="margin-top:12px;" class="grid">
      <form method="post" action="/admin/generate_key" class="grid">
        <input name="prefix" placeholder="–ø—Ä–µ—Ñ–∏–∫—Å (–æ–ø—Ü.) –Ω–∞–ø—Ä–∏–º–µ—Ä VIP" style="width:220px;">
        <button class="btn2" type="submit">Generate KEY</button>
      </form>
      <div style="color:#9aa4b2; font-size:13px;">
        –°–æ–≤–µ—Ç: –∫–ª–∏–µ–Ω—Ç –ø—Ä–∏—Å—ã–ª–∞–µ—Ç HWID ‚Üí —Ç—ã –≥–µ–Ω–µ—Ä–∏—à—å KEY ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—à—å –µ–º—É KEY.
      </div>
    </div>
  </div>

  <div class="section-title">üìã –°–ø–∏—Å–æ–∫ –ª–∏—Ü–µ–Ω–∑–∏–π</div>
  <div class="card">
    <table>
      <thead>
        <tr>
          <th>KEY</th>
          <th>HWID</th>
          <th>expires_at</th>
          <th>status</th>
          <th>plan</th>
          <th>checks</th>
          <th>note</th>
          <th>actions</th>
        </tr>
      </thead>

      <tbody>
      {% for r in rows %}
        <tr>
          <td class="mono">{{ r.key }}</td>
          <td class="mono">{{ r.hwid[:20] }}...</td>
          <td class="mono">{{ r.expires_at[:10] }}</td>

          <td>
            {% if r.revoked %}
              <span class="tag revoked">revoked</span>
            {% else %}
              <span class="tag active">active</span>
            {% endif %}
          </td>

          <td><span class="tag">{{ r.plan }}</span></td>
          <td class="mono">{{ r.check_count }}</td>
          <td>{{ r.note }}</td>

          <td class="row-actions">
            <form method="post" action="/admin/add_days">
              <input type="hidden" name="key" value="{{ r.key }}">
              <input type="hidden" name="add" value="30">
              <button class="okbtn" type="submit">+30</button>
            </form>

            <form method="post" action="/admin/add_days">
              <input type="hidden" name="key" value="{{ r.key }}">
              <input type="hidden" name="add" value="90">
              <button class="btn2" type="submit">+90</button>
            </form>

            {% if r.revoked %}
              <form method="post" action="/admin/unrevoke">
                <input type="hidden" name="key" value="{{ r.key }}">
                <button class="btn2" type="submit">Unrevoke</button>
              </form>
            {% else %}
              <form method="post" action="/admin/revoke" onsubmit="return confirm('–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á {{ r.key }}?');">
                <input type="hidden" name="key" value="{{ r.key }}">
                <button class="danger" type="submit">Revoke</button>
              </form>
            {% endif %}

            <form method="post" action="/admin/delete" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –∫–ª—é—á {{ r.key }}? –≠—Ç–æ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!');">
              <input type="hidden" name="key" value="{{ r.key }}">
              <button class="danger" type="submit">Delete</button>
            </form>
          </td>
        </tr>
      {% endfor %}
      </tbody>

    </table>

    <div style="margin-top:10px; color:#9aa4b2; font-size:13px;">
      –ü–æ–∫–∞–∑–∞–Ω–æ –º–∞–∫—Å–∏–º—É–º 500 –∑–∞–ø–∏—Å–µ–π. –ò—Å–ø–æ–ª—å–∑—É–π –ø–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä.
    </div>
  </div>

</div>
</body>
</html>
