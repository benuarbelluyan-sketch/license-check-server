<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>–õ–∏—Ü–µ–Ω–∑–∏–∏ ¬∑ TG Parser Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
    .container { max-width: 1400px; margin: 0 auto; padding: 40px 24px; }
    .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 32px; }
    .logo { display: flex; align-items: center; gap: 12px; }
    .logo-icon { width: 48px; height: 48px; background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 24px; border: 1px solid rgba(255,255,255,0.3); }
    .logo-text { font-size: 20px; font-weight: 700; color: #fff; }
    .logout-btn { background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3); border-radius: 12px; padding: 10px 20px; color: #fff; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
    .logout-btn:hover { background: rgba(255,255,255,0.3); }
    .nav { background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); border-radius: 16px; padding: 8px; display: flex; gap: 4px; margin-bottom: 32px; overflow-x: auto; }
    .nav-item { display: flex; align-items: center; gap: 8px; padding: 10px 18px; border-radius: 10px; color: rgba(255,255,255,0.7); text-decoration: none; font-size: 14px; font-weight: 600; transition: all 0.3s; white-space: nowrap; }
    .nav-item:hover { background: rgba(255,255,255,0.15); color: #fff; }
    .nav-item.active { background: #fff; color: #667eea; box-shadow: 0 4px 14px rgba(0,0,0,0.1); }

    /* –ö–∞—Ä—Ç–æ—á–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è */
    .create-card { background: #fff; border-radius: 20px; padding: 28px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 24px; }
    .create-title { font-size: 16px; font-weight: 700; color: #1a202c; margin-bottom: 20px; }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 14px; margin-bottom: 20px; }
    .form-group { display: flex; flex-direction: column; gap: 6px; }
    .form-label { font-size: 11px; font-weight: 600; color: #718096; text-transform: uppercase; letter-spacing: 0.5px; }
    .form-input { padding: 10px 14px; border: 1.5px solid #e2e8f0; border-radius: 10px; font-size: 13px; font-family: 'Inter', sans-serif; color: #2d3748; background: #f7fafc; transition: border-color 0.2s; outline: none; }
    .form-input:focus { border-color: #667eea; background: #fff; }
    .form-input::placeholder { color: #a0aec0; }
    .key-row { display: flex; gap: 8px; }
    .key-row .form-input { flex: 1; font-family: monospace; }
    .btn-gen { padding: 10px 14px; background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; border: none; border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: opacity 0.2s; }
    .btn-gen:hover { opacity: 0.85; }
    .form-actions { display: flex; align-items: center; gap: 14px; flex-wrap: wrap; }
    .btn-create { padding: 11px 28px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border: none; border-radius: 12px; font-size: 14px; font-weight: 700; cursor: pointer; transition: opacity 0.2s, transform 0.1s; }
    .btn-create:hover { opacity: 0.9; transform: translateY(-1px); }
    .form-hint { font-size: 12px; color: #a0aec0; }

    /* –¢–∞–±–ª–∏—Ü–∞ */
    .table-card { background: #fff; border-radius: 20px; padding: 28px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
    .table-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; }
    .table-title { font-size: 18px; font-weight: 700; color: #1a202c; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    thead { background: #f7fafc; }
    th { padding: 12px 16px; text-align: left; color: #718096; font-weight: 600; font-size: 12px; text-transform: uppercase; }
    td { padding: 14px 16px; border-top: 1px solid #f7fafc; vertical-align: middle; }
    tr:hover td { background: #f7fafc; }
    .badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; }
    .badge-active { background: #c6f6d5; color: #22543d; }
    .badge-expired { background: #fed7d7; color: #742a2a; }
    .badge-revoked { background: #e2e8f0; color: #4a5568; }
    .key-text { font-family: monospace; font-size: 12px; color: #4a5568; font-weight: 600; }
    .empty { text-align: center; padding: 60px; color: #a0aec0; }
    .action-btns { display: flex; gap: 6px; flex-wrap: wrap; }
    .btn-sm { padding: 5px 12px; border-radius: 8px; font-size: 11px; font-weight: 600; cursor: pointer; border: none; transition: opacity 0.2s; }
    .btn-sm:hover { opacity: 0.8; }
    .btn-extend { background: #ebf8ff; color: #2b6cb0; }
    .btn-revoke { background: #fff5f5; color: #c53030; }
    .btn-unrevoke { background: #f0fff4; color: #276749; }
    .btn-delete { background: #fff5f5; color: #c53030; }

    /* Flash */
    .flash { padding: 12px 20px; border-radius: 12px; margin-bottom: 20px; font-size: 13px; font-weight: 500; }
    .flash-ok { background: #c6f6d5; color: #22543d; }
    .flash-err { background: #fed7d7; color: #742a2a; }
  </style>
</head>
<body>
<div class="container">

  <div class="header">
    <div class="logo">
      <div class="logo-icon">üîë</div>
      <div class="logo-text">TG Parser Admin</div>
    </div>
    <form method="post" action="/admin/logout" style="margin:0;">
      <button class="logout-btn" type="submit">–í—ã–π—Ç–∏</button>
    </form>
  </div>

  <nav class="nav">
    <a href="/admin" class="nav-item">üìä –î–∞—à–±–æ—Ä–¥</a>
    <a href="/admin/users" class="nav-item">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
    <a href="/admin/licenses" class="nav-item active">üîë –õ–∏—Ü–µ–Ω–∑–∏–∏</a>
    <a href="/admin/devices" class="nav-item">üíª –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</a>
    <a href="/admin/transactions" class="nav-item">üí≥ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</a>
    <a href="/admin/settings" class="nav-item">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
  </nav>

  {% if request.query_params.get('ok') %}
  <div class="flash flash-ok">‚úÖ {{ request.query_params.get('ok') }}</div>
  {% endif %}
  {% if request.query_params.get('err') %}
  <div class="flash flash-err">‚ùå {{ request.query_params.get('err') }}</div>
  {% endif %}

  <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ª–∏—Ü–µ–Ω–∑–∏–∏ -->
  <div class="create-card">
    <div class="create-title">‚ú® –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –ª–∏—Ü–µ–Ω–∑–∏—é</div>
    <form method="post" action="/admin/upsert">
      <div class="form-grid">

        <div class="form-group">
          <label class="form-label">–ö–ª—é—á –ª–∏—Ü–µ–Ω–∑–∏–∏ *</label>
          <div class="key-row">
            <input class="form-input" name="key" id="keyInput" placeholder="BEN-XXXX-XXXX-XXXX" required>
            <button type="button" class="btn-gen" onclick="generateKey()">üé≤ –ê–≤—Ç–æ</button>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">HWID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</label>
          <input class="form-input" name="hwid" value="" placeholder="–ü—É—Å—Ç–æ = –ø—Ä–∏–≤—è–∂–µ—Ç—Å—è —Å–∞–º –ø—Ä–∏ –≤—Ö–æ–¥–µ">
        </div>

        <div class="form-group">
          <label class="form-label">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è (–¥–Ω–µ–π)</label>
          <input class="form-input" name="days" type="number" value="30" min="1" max="3650" required>
        </div>

        <div class="form-group">
          <label class="form-label">–ü–ª–∞–Ω</label>
          <select class="form-input" name="plan">
            <option value="custom">custom ‚Äî 1 —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</option>
            <option value="m1">m1 ‚Äî 1 —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</option>
            <option value="m3">m3 ‚Äî 2 —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</option>
            <option value="m6">m6 ‚Äî 3 —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</option>
            <option value="y1">y1 ‚Äî 5 —É—Å—Ç—Ä–æ–π—Å—Ç–≤</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</label>
          <input class="form-input" name="note" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ò–≤–∞–Ω, —Ç–µ—Å—Ç, VIP...">
        </div>

      </div>
      <div class="form-actions">
        <button class="btn-create" type="submit">üíæ –°–æ–∑–¥–∞—Ç—å –ª–∏—Ü–µ–Ω–∑–∏—é</button>
        <span class="form-hint">üí° –ü—É—Å—Ç–æ–π HWID ‚Äî –∫–ª—é—á –ø—Ä–∏–≤—è–∂–µ—Ç—Å—è –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º</span>
      </div>
    </form>
  </div>

  <!-- –¢–∞–±–ª–∏—Ü–∞ –ª–∏—Ü–µ–Ω–∑–∏–π -->
  <div class="table-card">
    <div class="table-header">
      <div class="table-title">–õ–∏—Ü–µ–Ω–∑–∏–∏ ({{ rows | length }})</div>
    </div>

    {% if rows %}
    <table>
      <thead>
        <tr>
          <th>–ö–ª—é—á</th>
          <th>–°—Ç–∞—Ç—É—Å</th>
          <th>–ü–ª–∞–Ω</th>
          <th>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</th>
          <th>–ò—Å—Ç–µ–∫–∞–µ—Ç</th>
          <th>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th>
          <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr>
          <td><div class="key-text">{{ r.key }}</div></td>
          <td>
            {% if r.revoked %}
              <span class="badge badge-revoked">üö´ –û—Ç–æ–∑–≤–∞–Ω–∞</span>
            {% elif r.expires_at > now %}
              <span class="badge badge-active">‚úÖ –ê–∫—Ç–∏–≤–Ω–∞</span>
            {% else %}
              <span class="badge badge-expired">‚ùå –ò—Å—Ç–µ–∫–ª–∞</span>
            {% endif %}
          </td>
          <td style="color:#4a5568; font-weight:500;">{{ r.plan or 'custom' }}</td>
          <td>
            <div style="display:flex;align-items:center;gap:4px;">
              <input type="number" min="1" max="50"
                value="{{ r.max_devices or 1 }}"
                style="width:54px;padding:3px 6px;border:1px solid #e2e8f0;border-radius:6px;font-size:13px;color:#4a5568;text-align:center;"
                onchange="updateLimit('{{ r.key }}', this.value, this)"
                title="–õ–∏–º–∏—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –¥–ª—è –∫–ª—é—á–∞"
              />
            </div>
          </td>
          <td style="color:#a0aec0; font-size:12px;">{{ r.expires_at.strftime('%d.%m.%Y') if r.expires_at else '‚Äî' }}</td>
          <td style="color:#a0aec0; font-size:12px;">{{ r.note or '‚Äî' }}</td>
          <td>
            <div class="action-btns">
              <form method="post" action="/admin/add_days" style="display:inline;">
                <input type="hidden" name="key" value="{{ r.key }}">
                <input type="hidden" name="add" value="30">
                <button class="btn-sm btn-extend" type="submit">+30–¥</button>
              </form>
              {% if r.revoked %}
              <form method="post" action="/admin/unrevoke" style="display:inline;">
                <input type="hidden" name="key" value="{{ r.key }}">
                <button class="btn-sm btn-unrevoke" type="submit">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
              </form>
              {% else %}
              <form method="post" action="/admin/revoke" style="display:inline;"
                onsubmit="return confirm('–û—Ç–æ–∑–≤–∞—Ç—å –∫–ª—é—á {{ r.key }}?')">
                <input type="hidden" name="key" value="{{ r.key }}">
                <button class="btn-sm btn-revoke" type="submit">–û—Ç–æ–∑–≤–∞—Ç—å</button>
              </form>
              {% endif %}
              <form method="post" action="/admin/delete" style="display:inline;"
                onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –∫–ª—é—á {{ r.key }}? –≠—Ç–æ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!')">
                <input type="hidden" name="key" value="{{ r.key }}">
                <button class="btn-sm btn-delete" type="submit">üóë</button>
              </form>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <div class="empty">
      <div style="font-size:48px; opacity:0.3; margin-bottom:12px;">üîë</div>
      <div>–õ–∏—Ü–µ–Ω–∑–∏–π –Ω–µ—Ç. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –≤—ã—à–µ.</div>
    </div>
    {% endif %}
  </div>

</div>
<script>
  function generateKey() {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    const part = (n) => Array.from({length: n}, () => chars[Math.floor(Math.random() * chars.length)]).join('');
    document.getElementById('keyInput').value = 'BEN-' + part(4) + '-' + part(4) + '-' + part(4);
  }

  async function updateLimit(key, val, el) {
    const max_devices = parseInt(val);
    if (!max_devices || max_devices < 1) return;
    try {
      const res = await fetch('/admin/api/update-limit', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({key, max_devices})
      });
      const data = await res.json();
      if (data.success) {
        el.style.borderColor = '#48bb78';
        setTimeout(() => el.style.borderColor = '#e2e8f0', 1500);
      } else {
        el.style.borderColor = '#fc8181';
      }
    } catch(e) {
      el.style.borderColor = '#fc8181';
    }
  }
</script>
</body>
</html>
