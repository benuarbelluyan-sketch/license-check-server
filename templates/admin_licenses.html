<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–õ–∏—Ü–µ–Ω–∑–∏–∏ ‚Äî Admin</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#07080a;--surface:#0d0f14;--surface2:#131720;--border:#1c2230;--border2:#252d3d;
    --text:#e2e8f5;--muted:#5a6580;--muted2:#7a8aa8;--accent:#3b7aff;--accent2:#5c94ff;
    --green:#22d87a;--red:#ff4e6a;--yellow:#ffb83a;--purple:#9f7aff;--cyan:#22d8d8;
    --font:'Syne',sans-serif;--mono:'JetBrains Mono',monospace;
    --sidebar:220px;--radius:14px;--radius-sm:8px;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{font-family:var(--font);background:var(--bg);color:var(--text);display:flex;min-height:100vh;}
  .sidebar{width:var(--sidebar);min-height:100vh;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;padding:24px 0;position:fixed;left:0;top:0;bottom:0;z-index:100;}
  .logo{padding:0 20px 24px;border-bottom:1px solid var(--border);margin-bottom:16px;}
  .logo-name{font-size:17px;font-weight:800;letter-spacing:-0.5px;color:var(--text);line-height:1;}
  .logo-name span{color:var(--accent2);}
  .logo-sub{font-size:11px;color:var(--muted);margin-top:4px;font-family:var(--mono);text-transform:uppercase;letter-spacing:1px;}
  .nav{flex:1;padding:0 12px;display:flex;flex-direction:column;gap:2px;}
  .nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:var(--radius-sm);color:var(--muted2);text-decoration:none;font-size:14px;font-weight:600;transition:all .15s;position:relative;}
  .nav-item:hover{background:var(--surface2);color:var(--text);}
  .nav-item.active{background:rgba(59,122,255,.12);color:var(--accent2);}
  .nav-item.active::before{content:'';position:absolute;left:0;top:20%;bottom:20%;width:3px;background:var(--accent);border-radius:0 3px 3px 0;}
  .nav-icon{font-size:16px;width:20px;text-align:center;}
  .sidebar-footer{padding:16px 12px 0;border-top:1px solid var(--border);}
  .admin-label{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--muted);padding:8px 12px;font-family:var(--mono);}
  .admin-dot{width:7px;height:7px;background:var(--green);border-radius:50%;}
  .logout-btn{width:100%;background:transparent;border:1px solid var(--border2);color:var(--muted2);padding:9px 12px;border-radius:var(--radius-sm);font-size:13px;font-weight:600;cursor:pointer;font-family:var(--font);transition:all .15s;margin-top:8px;}
  .logout-btn:hover{background:var(--red);border-color:var(--red);color:#fff;}
  .main{margin-left:var(--sidebar);flex:1;min-height:100vh;display:flex;flex-direction:column;}
  .topbar{height:60px;border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 28px;gap:16px;background:var(--surface);position:sticky;top:0;z-index:50;}
  .page-title{font-size:18px;font-weight:800;letter-spacing:-0.5px;}
  .topbar-right{margin-left:auto;display:flex;align-items:center;gap:10px;}
  .content{padding:28px;flex:1;}
  .btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:var(--radius-sm);font-size:12px;font-weight:700;cursor:pointer;border:none;font-family:var(--font);transition:all .15s;text-decoration:none;white-space:nowrap;}
  .btn-primary{background:var(--accent);color:#fff;}
  .btn-primary:hover{background:var(--accent2);}
  .btn-ghost{background:transparent;border:1px solid var(--border2);color:var(--muted2);}
  .btn-ghost:hover{background:var(--surface2);color:var(--text);}
  .btn-danger{background:rgba(255,78,106,.1);color:var(--red);border:1px solid rgba(255,78,106,.2);}
  .btn-danger:hover{background:var(--red);color:#fff;border-color:var(--red);}
  .btn-success{background:rgba(34,216,122,.1);color:var(--green);border:1px solid rgba(34,216,122,.2);}
  .btn-success:hover{background:var(--green);color:#000;border-color:var(--green);}
  .btn-warn{background:rgba(255,184,58,.1);color:var(--yellow);border:1px solid rgba(255,184,58,.2);}
  .btn-warn:hover{background:var(--yellow);color:#000;border-color:var(--yellow);}
  .btn-sm{padding:5px 10px;font-size:11px;}
  .table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;}
  table{width:100%;border-collapse:collapse;font-size:13px;}
  thead th{background:var(--surface2);padding:10px 16px;text-align:left;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--muted);font-family:var(--mono);border-bottom:1px solid var(--border);white-space:nowrap;}
  tbody tr{border-bottom:1px solid var(--border);transition:background .1s;}
  tbody tr:last-child{border-bottom:none;}
  tbody tr:hover{background:rgba(19,23,32,.8);}
  tbody td{padding:11px 16px;vertical-align:middle;}
  .mono{font-family:var(--mono);font-size:12px;}
  .text-muted{color:var(--muted2);}
  .badge{display:inline-flex;align-items:center;gap:5px;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:600;font-family:var(--mono);white-space:nowrap;}
  .badge::before{content:'';width:5px;height:5px;border-radius:50%;}
  .badge-green{background:rgba(34,216,122,.1);color:var(--green);border:1px solid rgba(34,216,122,.2);}
  .badge-green::before{background:var(--green);}
  .badge-red{background:rgba(255,78,106,.1);color:var(--red);border:1px solid rgba(255,78,106,.2);}
  .badge-red::before{background:var(--red);}
  .badge-yellow{background:rgba(255,184,58,.1);color:var(--yellow);border:1px solid rgba(255,184,58,.2);}
  .badge-yellow::before{background:var(--yellow);}
  .key-chip{font-family:var(--mono);font-size:12px;background:var(--surface2);border:1px solid var(--border2);border-radius:6px;padding:3px 8px;color:var(--accent2);display:inline-flex;align-items:center;gap:4px;}
  .copy-btn{background:none;border:none;cursor:pointer;color:var(--muted);font-size:12px;padding:2px 4px;border-radius:4px;transition:color .15s;}
  .copy-btn:hover{color:var(--accent2);}
  .expiry-ok{color:var(--green);}
  .expiry-soon{color:var(--yellow);}
  .expiry-expired{color:var(--red);}
  .action-bar{display:flex;align-items:center;gap:10px;margin-bottom:14px;flex-wrap:wrap;}
  .search-wrap{position:relative;flex:1;max-width:280px;}
  .search-icon{position:absolute;left:11px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:13px;pointer-events:none;}
  .search-input{background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);padding:8px 12px 8px 34px;color:var(--text);font-size:13px;font-family:var(--font);outline:none;width:100%;transition:border-color .15s;}
  .search-input:focus{border-color:var(--accent);}
  .search-input::placeholder{color:var(--muted);}
  .filter-tabs{display:flex;gap:3px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:3px;}
  .filter-tab{padding:5px 11px;border-radius:5px;font-size:12px;font-weight:700;cursor:pointer;color:var(--muted2);border:none;background:transparent;font-family:var(--font);transition:all .15s;white-space:nowrap;}
  .filter-tab:hover{color:var(--text);}
  .filter-tab.active{background:var(--surface);color:var(--text);box-shadow:0 1px 3px rgba(0,0,0,.3);}

  /* === DEVICE LIMIT EDITOR === */
  .limit-cell{display:flex;align-items:center;gap:6px;}
  .limit-display{display:flex;align-items:center;gap:8px;}
  .limit-val{font-family:var(--mono);font-size:14px;font-weight:700;color:var(--text);min-width:24px;text-align:center;}
  .limit-stepper{display:flex;flex-direction:column;gap:2px;}
  .step-btn{width:18px;height:12px;background:var(--surface2);border:1px solid var(--border2);border-radius:2px;cursor:pointer;color:var(--muted2);font-size:9px;display:flex;align-items:center;justify-content:center;transition:all .12s;line-height:1;}
  .step-btn:hover{background:var(--accent);border-color:var(--accent);color:#fff;}
  .limit-save{padding:3px 8px;background:rgba(34,216,122,.1);border:1px solid rgba(34,216,122,.2);border-radius:5px;color:var(--green);cursor:pointer;font-size:11px;font-weight:700;font-family:var(--font);transition:all .15s;display:none;}
  .limit-save.visible{display:inline-flex;align-items:center;gap:4px;}
  .limit-save:hover{background:var(--green);color:#000;border-color:var(--green);}

  /* === CREATE CARD === */
  .create-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:22px;margin-bottom:20px;overflow:hidden;}
  .create-header{display:flex;align-items:center;justify-content:space-between;cursor:pointer;user-select:none;}
  .create-title{font-size:14px;font-weight:700;display:flex;align-items:center;gap:8px;}
  .create-chevron{color:var(--muted);font-size:14px;transition:transform .2s;}
  .create-chevron.open{transform:rotate(180deg);}
  .create-body{margin-top:18px;}
  .create-body.hidden{display:none;}
  .form-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:12px;}
  .full-width{grid-column:1/-1;}
  .form-group{display:flex;flex-direction:column;gap:5px;}
  .form-label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--muted);font-family:var(--mono);}
  .form-input,.form-select{background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);padding:9px 12px;color:var(--text);font-size:13px;font-family:var(--font);outline:none;transition:border-color .15s;width:100%;}
  .form-input:focus,.form-select:focus{border-color:var(--accent);}
  .form-input::placeholder{color:var(--muted);}
  .form-select option{background:var(--surface2);}
  .form-footer{display:flex;align-items:center;gap:10px;margin-top:14px;flex-wrap:wrap;}
  .gen-key-wrap{flex:1;max-width:260px;position:relative;}
  .gen-key-input{padding-right:72px !important;}
  .gen-btn{position:absolute;right:4px;top:50%;transform:translateY(-50%);padding:4px 10px;border-radius:5px;background:var(--surface2);border:1px solid var(--border2);color:var(--accent2);font-size:11px;font-weight:700;font-family:var(--font);cursor:pointer;transition:all .15s;}
  .gen-btn:hover{background:var(--accent);border-color:var(--accent);color:#fff;}

  /* === MODAL === */
  .modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);z-index:1000;align-items:center;justify-content:center;}
  .modal-bg.open{display:flex;}
  .modal{background:var(--surface);border:1px solid var(--border2);border-radius:var(--radius);padding:28px;width:420px;max-width:95vw;animation:slideUp .2s ease;}
  @keyframes slideUp{from{opacity:0;transform:translateY(16px);}to{opacity:1;transform:translateY(0);}}
  .modal-title{font-size:16px;font-weight:800;margin-bottom:6px;}
  .modal-sub{font-size:13px;color:var(--muted2);margin-bottom:20px;}
  .modal-footer{display:flex;gap:10px;justify-content:flex-end;margin-top:20px;}

  .toast-wrap{position:fixed;bottom:24px;right:24px;z-index:2000;display:flex;flex-direction:column;gap:8px;}
  .toast{background:var(--surface);border:1px solid var(--border2);border-radius:var(--radius-sm);padding:12px 16px;font-size:13px;font-weight:600;display:flex;align-items:center;gap:8px;animation:toastIn .2s ease;min-width:240px;box-shadow:0 8px 24px rgba(0,0,0,.4);}
  .toast.ok{border-color:rgba(34,216,122,.3);}
  .toast.err{border-color:rgba(255,78,106,.3);}
  @keyframes toastIn{from{opacity:0;transform:translateX(16px);}to{opacity:1;transform:translateX(0);}}
  ::-webkit-scrollbar{width:6px;height:6px;}
  ::-webkit-scrollbar-track{background:transparent;}
  ::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px;}
  .stat-row{display:flex;gap:10px;margin-bottom:20px;}
  .mini-stat{flex:1;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px 16px;position:relative;overflow:hidden;}
  .mini-stat::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
  .mini-stat.g::before{background:var(--green);}
  .mini-stat.r::before{background:var(--red);}
  .mini-stat.y::before{background:var(--yellow);}
  .mini-stat.b::before{background:var(--accent);}
  .mini-stat-val{font-size:26px;font-weight:800;letter-spacing:-1px;}
  .mini-stat-val.g{color:var(--green);}
  .mini-stat-val.r{color:var(--red);}
  .mini-stat-val.y{color:var(--yellow);}
  .mini-stat-val.b{color:var(--accent2);}
  .mini-stat-label{font-size:11px;color:var(--muted);font-family:var(--mono);text-transform:uppercase;letter-spacing:.8px;margin-top:2px;}
  .row-actions{display:flex;gap:5px;align-items:center;}
</style>
</head>
<body>

<div class="sidebar">
  <div class="logo">
    <div class="logo-name"><span>TG</span> Parser Sender</div>
    <div class="logo-sub">Admin Panel</div>
  </div>
  <nav class="nav">
    <a href="/admin" class="nav-item {% if active_tab == 'dashboard' %}active{% endif %}">
      <span class="nav-icon">‚óà</span> –î–∞—à–±–æ—Ä–¥
    </a>
    <a href="/admin/licenses" class="nav-item {% if active_tab == 'licenses' %}active{% endif %}">
      <span class="nav-icon">‚åó</span> –õ–∏—Ü–µ–Ω–∑–∏–∏
    </a>
    <a href="/admin/users" class="nav-item {% if active_tab == 'users' %}active{% endif %}">
      <span class="nav-icon">‚óâ</span> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
    </a>
    <a href="/admin/devices" class="nav-item {% if active_tab == 'devices' %}active{% endif %}">
      <span class="nav-icon">‚äü</span> –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
    </a>
    <a href="/admin/transactions" class="nav-item {% if active_tab == 'transactions' %}active{% endif %}">
      <span class="nav-icon">‚âã</span> –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    </a>
    <a href="/admin/settings" class="nav-item {% if active_tab == 'settings' %}active{% endif %}">
      <span class="nav-icon">‚åò</span> –ù–∞—Å—Ç—Ä–æ–π–∫–∏
    </a>
  </nav>
  <div class="sidebar-footer">
    <div class="admin-label"><span class="admin-dot"></span>admin online</div>
    <form method="post" action="/admin/logout">
      <button class="logout-btn" type="submit">‚Ü© –í—ã–π—Ç–∏</button>
    </form>
  </div>
</div>

<div class="main">
  <div class="topbar">
    <span class="page-title">–õ–∏—Ü–µ–Ω–∑–∏–∏</span>
    <div class="topbar-right">
      <a href="/admin/export" class="btn btn-ghost btn-sm">‚Üì CSV</a>
      <button class="btn btn-primary btn-sm" onclick="toggleCreate()">+ –°–æ–∑–¥–∞—Ç—å</button>
    </div>
  </div>

  <div class="content">

    <!-- MINI STATS -->
    <div class="stat-row">
      <div class="mini-stat g">
        <div class="mini-stat-val g" id="cnt-active">‚Äî</div>
        <div class="mini-stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
      </div>
      <div class="mini-stat r">
        <div class="mini-stat-val r" id="cnt-expired">‚Äî</div>
        <div class="mini-stat-label">–ò—Å—Ç–µ–∫—à–∏—Ö</div>
      </div>
      <div class="mini-stat y">
        <div class="mini-stat-val y" id="cnt-revoked">‚Äî</div>
        <div class="mini-stat-label">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ</div>
      </div>
      <div class="mini-stat b">
        <div class="mini-stat-val b" id="cnt-total">{{ rows|length }}</div>
        <div class="mini-stat-label">–í—Å–µ–≥–æ</div>
      </div>
    </div>

    <!-- CREATE FORM (collapsible) -->
    <div class="create-card" id="createCard" style="display:none;">
      <div class="create-header" onclick="toggleCreate()">
        <div class="create-title">‚ú¶ –ù–æ–≤–∞—è –ª–∏—Ü–µ–Ω–∑–∏—è</div>
        <span class="create-chevron open" id="createChevron">‚ñ≤</span>
      </div>
      <div class="create-body" id="createBody">
        <form method="post" action="/admin/upsert">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">–ö–ª—é—á</label>
              <div class="gen-key-wrap">
                <input name="key" id="keyInp" class="form-input gen-key-input" placeholder="KEY-XXXXXXXX" required>
                <button type="button" class="gen-btn" onclick="genKey()">‚ü≥ –ê–≤—Ç–æ</button>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">–î–Ω–µ–π –¥–µ–π—Å—Ç–≤–∏—è</label>
              <input name="days" type="number" class="form-input" placeholder="30" value="30" min="1" required>
            </div>
            <div class="form-group">
              <label class="form-label">–õ–∏–º–∏—Ç –¥–µ–≤–∞–π—Å–æ–≤</label>
              <input name="max_devices" type="number" class="form-input" placeholder="1" value="1" min="1" max="99">
            </div>
            <div class="form-group">
              <label class="form-label">HWID (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω)</label>
              <input name="hwid" class="form-input" placeholder="–û—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º" value="temp">
            </div>
            <div class="form-group full-width">
              <label class="form-label">–ó–∞–º–µ—Ç–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
              <input name="note" class="form-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–ª–∏–µ–Ω—Ç –ò–≤–∞–Ω, –º–µ—Å—è—Ü">
            </div>
          </div>
          <div class="form-footer">
            <button type="submit" class="btn btn-primary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–∏—Ü–µ–Ω–∑–∏—é</button>
            <button type="button" class="btn btn-ghost" onclick="toggleCreate()">–û—Ç–º–µ–Ω–∞</button>
          </div>
        </form>
      </div>
    </div>

    <!-- ACTION BAR -->
    <div class="action-bar">
      <div class="search-wrap">
        <span class="search-icon">‚åï</span>
        <input type="text" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–ª—é—á—É, –∑–∞–º–µ—Ç–∫–µ..." oninput="filterTable(this.value)">
      </div>
      <div class="filter-tabs">
        <button class="filter-tab active" data-f="all" onclick="setFilter('all',this)">–í—Å–µ</button>
        <button class="filter-tab" data-f="active" onclick="setFilter('active',this)">–ê–∫—Ç–∏–≤–Ω—ã–µ</button>
        <button class="filter-tab" data-f="expired" onclick="setFilter('expired',this)">–ò—Å—Ç–µ–∫—à–∏–µ</button>
        <button class="filter-tab" data-f="revoked" onclick="setFilter('revoked',this)">–ó–∞–±–ª–æ–∫.</button>
      </div>
    </div>

    <!-- TABLE -->
    <div class="table-wrap">
      <table id="licTable">
        <thead>
          <tr>
            <th>–ö–ª—é—á</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–ò—Å—Ç–µ–∫–∞–µ—Ç</th>
            <th style="min-width:160px">–î–µ–≤–∞–π—Å–æ–≤ <span style="color:var(--muted);font-size:9px;font-weight:400;letter-spacing:0">‚Äî —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π –Ω–∞–ø—Ä—è–º—É—é</span></th>
            <th>–ó–∞–º–µ—Ç–∫–∞</th>
            <th>–°–æ–∑–¥–∞–Ω</th>
            <th style="min-width:180px">–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody>
          {% for row in rows %}
          <tr data-key="{{ row.key }}"
              data-status="{% if row.revoked %}revoked{% elif now > row.expires_at %}expired{% else %}active{% endif %}">
            <td>
              <span class="key-chip">{{ row.key }}</span>
              <button class="copy-btn" onclick="copyText('{{ row.key }}')" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å">‚éò</button>
            </td>
            <td>
              {% if row.revoked %}
                <span class="badge badge-red">–ó–∞–±–ª–æ–∫.</span>
              {% elif now > row.expires_at %}
                <span class="badge badge-yellow">–ò—Å—Ç—ë–∫</span>
              {% else %}
                <span class="badge badge-green">–ê–∫—Ç–∏–≤–µ–Ω</span>
              {% endif %}
            </td>
            <td>
              {% set days_left = (row.expires_at - now).days %}
              {% if now > row.expires_at %}
                <span class="expiry-expired mono">{{ row.expires_at.strftime('%d.%m.%Y') }}</span>
              {% elif days_left < 7 %}
                <span class="expiry-soon mono" title="{{ days_left }} –¥–Ω. –æ—Å—Ç–∞–ª–æ—Å—å">{{ row.expires_at.strftime('%d.%m.%Y') }}</span>
              {% else %}
                <span class="expiry-ok mono">{{ row.expires_at.strftime('%d.%m.%Y') }}</span>
              {% endif %}
            </td>
            <!-- ‚òÖ INLINE LIMIT EDITOR ‚òÖ -->
            <td>
              <div class="limit-cell" id="lc-{{ row.key | replace('-', '_') }}">
                <div class="limit-display">
                  <div class="limit-stepper">
                    <button class="step-btn" onclick="stepLimit('{{ row.key }}', 1)">‚ñ≤</button>
                    <button class="step-btn" onclick="stepLimit('{{ row.key }}', -1)">‚ñº</button>
                  </div>
                  <span class="limit-val" id="lv-{{ row.key | replace('-', '_') }}">{{ row.max_devices }}</span>
                </div>
                <button class="limit-save" id="ls-{{ row.key | replace('-', '_') }}"
                        onclick="saveLimit('{{ row.key }}')">‚úì –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              </div>
            </td>
            <td>
              {% if row.note %}
                <span style="color:var(--muted2);font-size:12px;">{{ row.note }}</span>
              {% else %}
                <span style="color:var(--muted)">‚Äî</span>
              {% endif %}
            </td>
            <td><span class="mono text-muted">{{ row.created_at.strftime('%d.%m.%y') if row.created_at else '‚Äî' }}</span></td>
            <td>
              <div class="row-actions">
                <!-- –î–æ–±–∞–≤–∏—Ç—å –¥–Ω–∏ -->
                <button class="btn btn-ghost btn-sm" onclick="openAddDays('{{ row.key }}')" title="–ü—Ä–æ–¥–ª–∏—Ç—å">+–¥–Ω–∏</button>
                <!-- Revoke / Unrevoke -->
                {% if row.revoked %}
                  <form method="post" action="/admin/unrevoke" style="margin:0">
                    <input type="hidden" name="key" value="{{ row.key }}">
                    <button class="btn btn-success btn-sm">‚Ü©</button>
                  </form>
                {% else %}
                  <form method="post" action="/admin/revoke" style="margin:0">
                    <input type="hidden" name="key" value="{{ row.key }}">
                    <button class="btn btn-danger btn-sm">üö´</button>
                  </form>
                {% endif %}
                <!-- Delete -->
                <form method="post" action="/admin/delete" style="margin:0" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –∫–ª—é—á {{ row.key }}?')">
                  <input type="hidden" name="key" value="{{ row.key }}">
                  <button class="btn btn-ghost btn-sm" title="–£–¥–∞–ª–∏—Ç—å" style="color:var(--red);">‚úï</button>
                </form>
              </div>
            </td>
          </tr>
          {% else %}
          <tr><td colspan="7" style="padding:40px;text-align:center;color:var(--muted);">–õ–∏—Ü–µ–Ω–∑–∏–π –Ω–µ—Ç</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>
</div>

<!-- ADD DAYS MODAL -->
<div class="modal-bg" id="addDaysModal">
  <div class="modal">
    <div class="modal-title">üìÖ –ü—Ä–æ–¥–ª–∏—Ç—å –ª–∏—Ü–µ–Ω–∑–∏—é</div>
    <div class="modal-sub" id="addDaysKey">–ö–ª—é—á: ‚Äî</div>
    <form method="post" action="/admin/add_days" id="addDaysForm">
      <input type="hidden" name="key" id="addDaysKeyInput">
      <div class="form-group">
        <label class="form-label">–î–æ–±–∞–≤–∏—Ç—å –¥–Ω–µ–π</label>
        <input name="add" type="number" class="form-input" value="30" min="1" max="3650">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-ghost" onclick="closeModal('addDaysModal')">–û—Ç–º–µ–Ω–∞</button>
        <button type="submit" class="btn btn-primary">‚úì –ü—Ä–æ–¥–ª–∏—Ç—å</button>
      </div>
    </form>
  </div>
</div>

<div class="toast-wrap" id="toasts"></div>

<script>
  // ===== LIMIT EDITING =====
  const limitState = {}; // key -> {original, current}

  {% for row in rows %}
  limitState['{{ row.key }}'] = { original: {{ row.max_devices }}, current: {{ row.max_devices }} };
  {% endfor %}

  function stepLimit(key, delta) {
    const safeKey = key.replace(/-/g, '_');
    const state = limitState[key];
    const newVal = Math.max(1, Math.min(99, state.current + delta));
    if (newVal === state.current) return;
    state.current = newVal;
    document.getElementById('lv-' + safeKey).textContent = newVal;
    const saveBtn = document.getElementById('ls-' + safeKey);
    if (newVal !== state.original) {
      saveBtn.classList.add('visible');
    } else {
      saveBtn.classList.remove('visible');
    }
  }

  async function saveLimit(key) {
    const safeKey = key.replace(/-/g, '_');
    const state = limitState[key];
    const saveBtn = document.getElementById('ls-' + safeKey);
    saveBtn.textContent = '...';
    try {
      const res = await fetch('/admin/api/update-limit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ key: key, max_devices: state.current })
      });
      const data = await res.json();
      if (data.success) {
        state.original = state.current;
        saveBtn.classList.remove('visible');
        showToast('‚úì –õ–∏–º–∏—Ç –¥–µ–≤–∞–π—Å–æ–≤: ' + state.current, 'ok');
      } else {
        showToast('–û—à–∏–±–∫–∞: ' + (data.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'), 'err');
        saveBtn.textContent = '‚úì –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
      }
    } catch(e) {
      showToast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'err');
      saveBtn.textContent = '‚úì –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
    }
  }

  // ===== STATS COUNTER =====
  function calcStats() {
    const rows = document.querySelectorAll('#licTable tbody tr[data-status]');
    let active = 0, expired = 0, revoked = 0;
    rows.forEach(r => {
      const s = r.dataset.status;
      if (s === 'active') active++;
      else if (s === 'expired') expired++;
      else if (s === 'revoked') revoked++;
    });
    document.getElementById('cnt-active').textContent = active;
    document.getElementById('cnt-expired').textContent = expired;
    document.getElementById('cnt-revoked').textContent = revoked;
  }
  calcStats();

  // ===== FILTER =====
  let currentFilter = 'all';
  let currentSearch = '';

  function setFilter(f, el) {
    currentFilter = f;
    document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    applyFilter();
  }

  function filterTable(q) {
    currentSearch = q.toLowerCase();
    applyFilter();
  }

  function applyFilter() {
    const rows = document.querySelectorAll('#licTable tbody tr[data-status]');
    rows.forEach(r => {
      const status = r.dataset.status;
      const text = r.textContent.toLowerCase();
      const matchFilter = currentFilter === 'all' || status === currentFilter;
      const matchSearch = !currentSearch || text.includes(currentSearch);
      r.style.display = (matchFilter && matchSearch) ? '' : 'none';
    });
  }

  // ===== CREATE TOGGLE =====
  function toggleCreate() {
    const card = document.getElementById('createCard');
    const chevron = document.getElementById('createChevron');
    if (card.style.display === 'none') {
      card.style.display = 'block';
    } else {
      card.style.display = 'none';
    }
  }

  // ===== GEN KEY =====
  function genKey() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    const part = () => Array.from({length:4}, ()=>chars[Math.floor(Math.random()*chars.length)]).join('');
    document.getElementById('keyInp').value = `KEY-${part()}-${part()}`;
  }

  // ===== MODAL =====
  function openAddDays(key) {
    document.getElementById('addDaysKey').textContent = '–ö–ª—é—á: ' + key;
    document.getElementById('addDaysKeyInput').value = key;
    document.getElementById('addDaysModal').classList.add('open');
  }
  function closeModal(id) {
    document.getElementById(id).classList.remove('open');
  }
  document.getElementById('addDaysModal').addEventListener('click', function(e){
    if(e.target === this) closeModal('addDaysModal');
  });

  // ===== COPY =====
  function copyText(text) {
    navigator.clipboard.writeText(text).then(() => showToast('‚éò –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ: ' + text, 'ok'));
  }

  // ===== TOAST =====
  function showToast(msg, type='ok') {
    const wrap = document.getElementById('toasts');
    const t = document.createElement('div');
    t.className = 'toast ' + type;
    t.textContent = msg;
    wrap.appendChild(t);
    setTimeout(() => t.remove(), 3000);
  }
</script>
</body>
</html>
