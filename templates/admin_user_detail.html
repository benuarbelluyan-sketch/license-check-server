<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å #{{ user.id }} ¬∑ TG Parser Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', system-ui, sans-serif; background: #0a0c10; color: #e5e9f0; line-height: 1.5; }
    .app { display: flex; min-height: 100vh; }

    /* SIDEBAR */
    .sidebar { width: 220px; background: #0d1117; border-right: 1px solid #1e2530; padding: 24px 0; flex-shrink: 0; }
    .sidebar-logo { padding: 0 20px 24px; font-weight: 700; font-size: 16px; color: #58a6ff; }
    .sidebar-logo span { color: #e5e9f0; }
    .nav-item { display: flex; align-items: center; gap: 10px; padding: 10px 20px; color: #8b949e; text-decoration: none; font-size: 14px; transition: all .15s; }
    .nav-item:hover { background: #161b22; color: #e5e9f0; }
    .nav-item.active { background: #161b22; color: #58a6ff; border-left: 2px solid #58a6ff; }

    /* MAIN */
    .main { flex: 1; padding: 28px 32px; max-width: 1100px; }
    .back-link { display: inline-flex; align-items: center; gap: 6px; color: #8b949e; text-decoration: none; font-size: 13px; margin-bottom: 20px; }
    .back-link:hover { color: #58a6ff; }

    /* PROFILE HEADER */
    .profile-header { background: #0d1117; border: 1px solid #1e2530; border-radius: 12px; padding: 24px; margin-bottom: 20px; display: flex; align-items: center; gap: 20px; }
    .avatar { width: 60px; height: 60px; border-radius: 50%; background: #21262d; display: flex; align-items: center; justify-content: center; font-size: 26px; flex-shrink: 0; }
    .profile-info h2 { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
    .profile-meta { display: flex; gap: 10px; flex-wrap: wrap; }
    .badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; }
    .badge-green { background: #1a3a28; color: #3fb950; }
    .badge-red { background: #3a2020; color: #f85149; }
    .badge-blue { background: #1a2e4a; color: #58a6ff; }
    .badge-gray { background: #1e2530; color: #8b949e; }
    .badge-yellow { background: #2a1f10; color: #d29922; }

    /* GRID LAYOUT */
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 16px; }

    /* CARDS */
    .card { background: #0d1117; border: 1px solid #1e2530; border-radius: 12px; padding: 20px; }
    .card-title { font-size: 13px; font-weight: 700; color: #8b949e; text-transform: uppercase; letter-spacing: .5px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
    .card-title .icon { font-size: 16px; }

    /* FIELDS */
    .field { margin-bottom: 12px; }
    .field label { display: block; font-size: 11px; color: #8b949e; text-transform: uppercase; letter-spacing: .3px; margin-bottom: 5px; }
    .field-value { font-size: 14px; font-weight: 500; }
    .field input[type=text], .field input[type=email], .field input[type=number], .field select {
      width: 100%; background: #161b22; border: 1px solid #30363d; border-radius: 6px;
      padding: 8px 12px; color: #e5e9f0; font-size: 13px; outline: none;
    }
    .field input:focus, .field select:focus { border-color: #58a6ff; }

    /* STAT BOXES */
    .stat-box { background: #161b22; border-radius: 8px; padding: 14px 16px; }
    .stat-label { font-size: 11px; color: #8b949e; margin-bottom: 4px; }
    .stat-val { font-size: 22px; font-weight: 700; }
    .stat-sub { font-size: 11px; color: #8b949e; margin-top: 2px; }

    /* BUTTONS */
    .btn { display: inline-flex; align-items: center; gap: 6px; border: none; border-radius: 8px; padding: 9px 16px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all .15s; }
    .btn-primary { background: #238636; color: #fff; }
    .btn-primary:hover { background: #2ea043; }
    .btn-blue { background: #1f6feb; color: #fff; }
    .btn-blue:hover { background: #388bfd; }
    .btn-yellow { background: #9e6a03; color: #fff; }
    .btn-yellow:hover { background: #bb8009; }
    .btn-red { background: #6e2020; color: #f85149; }
    .btn-red:hover { background: #8e2f2f; }
    .btn-gray { background: #21262d; color: #e5e9f0; border: 1px solid #30363d; }
    .btn-gray:hover { background: #30363d; }
    .btn-sm { padding: 6px 12px; font-size: 12px; }

    .btn-row { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }

    /* TABLE */
    .mini-table { width: 100%; border-collapse: collapse; font-size: 12px; }
    .mini-table th { padding: 8px 10px; text-align: left; color: #8b949e; font-size: 11px; text-transform: uppercase; border-bottom: 1px solid #1e2530; }
    .mini-table td { padding: 8px 10px; border-bottom: 1px solid #161b22; vertical-align: middle; }
    .mini-table tr:last-child td { border-bottom: none; }

    /* DIVIDER */
    .divider { height: 1px; background: #1e2530; margin: 16px 0; }

    /* TOAST */
    #toast { position: fixed; bottom: 24px; right: 24px; background: #238636; color: #fff; padding: 12px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; display: none; z-index: 999; box-shadow: 0 4px 20px rgba(0,0,0,.4); }
    #toast.error { background: #6e2020; color: #f85149; }

    .logout-btn { background: none; border: 1px solid #30363d; border-radius: 6px; padding: 7px 14px; color: #8b949e; font-size: 13px; cursor: pointer; }
    .logout-btn:hover { border-color: #f85149; color: #f85149; }

    .tag-device { display: inline-flex; align-items: center; gap: 8px; background: #161b22; border: 1px solid #30363d; border-radius: 6px; padding: 5px 10px; font-size: 12px; margin: 3px; }
    .tag-device .d-name { font-weight: 500; }
    .tag-device .d-date { color: #8b949e; }
    .tag-device button { background: none; border: none; color: #f85149; cursor: pointer; font-size: 14px; line-height: 1; padding: 0; }

    .amount-plus { color: #3fb950; font-weight: 600; }
    .amount-minus { color: #f85149; font-weight: 600; }

    .section-title { font-size: 16px; font-weight: 700; margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }
  </style>
</head>
<body>
<div class="app">
  <!-- Sidebar -->
  <nav class="sidebar">
    <div class="sidebar-logo">TG Parser <span>Admin</span></div>
    <a href="/admin" class="nav-item">üìä –î–∞—à–±–æ—Ä–¥</a>
    <a href="/admin/users" class="nav-item active">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
    <a href="/admin/licenses" class="nav-item">üîë –õ–∏—Ü–µ–Ω–∑–∏–∏</a>
    <a href="/admin/devices" class="nav-item">üíª –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</a>
    <a href="/admin/transactions" class="nav-item">üí≥ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</a>
    <a href="/admin/settings" class="nav-item">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
  </nav>

  <div class="main">
    <a href="/admin/users" class="back-link">‚Üê –ù–∞–∑–∞–¥ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</a>

    <!-- Profile Header -->
    <div class="profile-header">
      <div class="avatar">üë§</div>
      <div class="profile-info" style="flex:1;">
        <h2>{{ user.email }}</h2>
        <div class="profile-meta">
          <span class="badge badge-gray">#{{ user.id }}</span>
          {% if user.email_confirmed %}
            <span class="badge badge-blue">‚úì Email –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω</span>
          {% else %}
            <span class="badge badge-yellow">‚ö† Email –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω</span>
          {% endif %}
          {% if user.license_key %}
            {% if user.license_revoked %}
              <span class="badge badge-red">üö´ –õ–∏—Ü–µ–Ω–∑–∏—è –æ—Ç–æ–∑–≤–∞–Ω–∞</span>
            {% elif user.license_expires and user.license_expires > now %}
              {% set days = ((user.license_expires - now).total_seconds() / 86400) | int %}
              <span class="badge badge-green">‚úÖ –ê–∫—Ç–∏–≤–Ω–∞ ({{ days }}–¥)</span>
            {% else %}
              <span class="badge badge-red">‚ùå –õ–∏—Ü–µ–Ω–∑–∏—è –∏—Å—Ç–µ–∫–ª–∞</span>
            {% endif %}
          {% else %}
            <span class="badge badge-gray">–ù–µ—Ç –ª–∏—Ü–µ–Ω–∑–∏–∏</span>
          {% endif %}
          {% if user.created_at %}
            <span class="badge badge-gray">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: {{ user.created_at.strftime('%d.%m.%Y') }}</span>
          {% endif %}
        </div>
      </div>
      <form method="post" action="/admin/logout" style="margin:0;">
        <button class="logout-btn" type="submit">–í—ã–π—Ç–∏</button>
      </form>
    </div>

    <!-- Stats Row -->
    <div class="grid-3" style="margin-bottom:20px;">
      <div class="stat-box">
        <div class="stat-label">üí∞ –ë–∞–ª–∞–Ω—Å</div>
        <div class="stat-val" style="color:#3fb950;">${{ "%.2f" | format(user.balance | default(0) | float) }}</div>
        <div class="stat-sub">–î–æ—Å—Ç—É–ø–Ω–æ</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">üíª –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</div>
        <div class="stat-val">{{ devices | selectattr('is_active') | list | length }}<span style="font-size:14px; color:#8b949e;">/{{ user.max_devices or 1 }}</span></div>
        <div class="stat-sub">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">üìã –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</div>
        <div class="stat-val">{{ transactions | length }}</div>
        <div class="stat-sub">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 50</div>
      </div>
    </div>

    <!-- ROW 1: Email + Password -->
    <div class="grid-2">
      <!-- Email Management -->
      <div class="card">
        <div class="card-title"><span class="icon">üìß</span> Email</div>
        <div class="field">
          <label>–¢–µ–∫—É—â–∏–π email</label>
          <input type="email" id="email-input" value="{{ user.email }}" />
        </div>
        <div class="btn-row">
          <button class="btn btn-primary btn-sm" onclick="updateEmail()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å email</button>
          <button class="btn btn-blue btn-sm" onclick="confirmEmail()">‚úì –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å email</button>
        </div>
      </div>

      <!-- Password Reset -->
      <div class="card">
        <div class="card-title"><span class="icon">üîê</span> –ü–∞—Ä–æ–ª—å</div>
        <div class="field">
          <label>Email –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—Å—ã–ª–∫–∏</label>
          <input type="text" id="reset-email" value="{{ user.email }}" />
        </div>
        <div class="btn-row">
          <button class="btn btn-yellow btn-sm" onclick="resetPassword()">üì© –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è</button>
        </div>
      </div>
    </div>

    <!-- ROW 2: License + Balance -->
    <div class="grid-2">
      <!-- License Management -->
      <div class="card">
        <div class="card-title"><span class="icon">üîë</span> –õ–∏—Ü–µ–Ω–∑–∏—è</div>
        {% if user.license_key %}
        <div class="field">
          <label>–ö–ª—é—á</label>
          <div class="field-value" style="font-family:monospace; font-size:12px; color:#8b949e;">{{ user.license_key }}</div>
        </div>
        <div class="field">
          <label>–ò—Å—Ç–µ–∫–∞–µ—Ç</label>
          <div class="field-value">
            {% if user.license_expires %}
              {{ user.license_expires.strftime('%d.%m.%Y %H:%M') }}
            {% else %}
              ‚Äî
            {% endif %}
          </div>
        </div>
        <div class="field">
          <label>–ü—Ä–æ–¥–ª–∏—Ç—å –Ω–∞</label>
          <select id="extend-days">
            <option value="7">7 –¥–Ω–µ–π</option>
            <option value="30" selected>30 –¥–Ω–µ–π</option>
            <option value="90">90 –¥–Ω–µ–π</option>
            <option value="180">180 –¥–Ω–µ–π</option>
            <option value="365">1 –≥–æ–¥</option>
          </select>
        </div>
        <div class="btn-row">
          <button class="btn btn-primary btn-sm" onclick="extendLicense()">‚ûï –ü—Ä–æ–¥–ª–∏—Ç—å</button>
          {% if user.license_revoked %}
            <button class="btn btn-blue btn-sm" onclick="revokeLicense(false)">‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
          {% else %}
            <button class="btn btn-red btn-sm" onclick="revokeLicense(true)">üö´ –û—Ç–æ–∑–≤–∞—Ç—å</button>
          {% endif %}
        </div>
        {% else %}
        <div style="color:#8b949e; font-size:13px;">–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –ª–∏—Ü–µ–Ω–∑–∏–∏</div>
        {% endif %}
      </div>

      <!-- Balance & Deposit -->
      <div class="card">
        <div class="card-title"><span class="icon">üí∞</span> –ë–∞–ª–∞–Ω—Å</div>
        <div class="field">
          <label>–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</label>
          <div class="stat-val" id="balance-display" style="color:#3fb950; font-size:20px;">${{ "%.2f" | format(user.balance | default(0) | float) }}</div>
        </div>
        <div class="divider"></div>
        <div class="field">
          <label>–°—É–º–º–∞ (+ –ø–æ–ø–æ–ª–Ω–∏—Ç—å, - —Å–Ω—è—Ç—å)</label>
          <input type="number" id="deposit-amount" value="10" step="0.01" />
        </div>
        <div class="field">
          <label>–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏</label>
          <select id="deposit-type">
            <option value="deposit">üí≥ –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</option>
            <option value="bonus">üéÅ –ë–æ–Ω—É—Å</option>
            <option value="refund">‚Ü©Ô∏è –í–æ–∑–≤—Ä–∞—Ç</option>
            <option value="withdrawal">üì§ –°–ø–∏—Å–∞–Ω–∏–µ</option>
            <option value="adjustment">üîß –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞</option>
          </select>
        </div>
        <div class="field">
          <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
          <input type="text" id="deposit-note" placeholder="–ü—Ä–∏—á–∏–Ω–∞ / –∏—Å—Ç–æ—á–Ω–∏–∫..." />
        </div>
        <div class="btn-row">
          <button class="btn btn-primary btn-sm" onclick="addDeposit()">üíæ –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
      </div>
    </div>

    <!-- Devices -->
    <div class="card" style="margin-bottom:16px;">
      <div class="card-title"><span class="icon">üíª</span> –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</div>
      
      <div class="field" style="margin-bottom:14px;">
        <label>–õ–∏–º–∏—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤</label>
        <div style="display:flex; gap:8px; align-items:center;">
          <input type="number" id="device-limit" value="{{ user.max_devices or 1 }}" min="1" max="20" style="width:80px;" />
          <button class="btn btn-gray btn-sm" onclick="updateDeviceLimit()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–∏–º–∏—Ç</button>
          <button class="btn btn-red btn-sm" onclick="unlinkAllDevices()">üóë –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</button>
        </div>
      </div>

      {% if devices %}
        <div>
          {% for d in devices %}
          <div class="tag-device" id="device-{{ d.id }}">
            <span>{% if d.is_active %}üü¢{% else %}‚ö´{% endif %}</span>
            <span class="d-name">{{ d.device_name or d.device_fingerprint[:16] ~ '...' }}</span>
            <span class="d-date">{{ d.last_login.strftime('%d.%m.%Y') if d.last_login else '' }}</span>
            {% if d.last_ip %}<span style="color:#8b949e; font-size:11px;">{{ d.last_ip }}</span>{% endif %}
            {% if d.is_active %}
              <button onclick="unlinkDevice({{ d.id }})" title="–û—Ç–≤—è–∑–∞—Ç—å">‚úï</button>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      {% else %}
        <div style="color:#8b949e; font-size:13px;">–ù–µ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤</div>
      {% endif %}
    </div>

    <!-- Transactions -->
    <div class="card">
      <div class="card-title"><span class="icon">üí≥</span> –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</div>
      {% if transactions %}
      <table class="mini-table">
        <thead>
          <tr>
            <th>–î–∞—Ç–∞</th>
            <th>–¢–∏–ø</th>
            <th>–°—É–º–º–∞</th>
            <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
          </tr>
        </thead>
        <tbody>
          {% for t in transactions %}
          <tr>
            <td style="color:#8b949e;">{{ t.created_at.strftime('%d.%m.%Y %H:%M') if t.created_at else '‚Äî' }}</td>
            <td>
              {% if t.type == 'deposit' %}<span class="badge badge-green">üí≥ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</span>
              {% elif t.type == 'bonus' %}<span class="badge badge-blue">üéÅ –±–æ–Ω—É—Å</span>
              {% elif t.type == 'refund' %}<span class="badge badge-blue">‚Ü©Ô∏è –≤–æ–∑–≤—Ä–∞—Ç</span>
              {% elif t.type == 'withdrawal' %}<span class="badge badge-red">üì§ —Å–ø–∏—Å–∞–Ω–∏–µ</span>
              {% elif t.type == 'charge' %}<span class="badge badge-red">‚ö° —Ä–∞—Å—Ö–æ–¥</span>
              {% else %}<span class="badge badge-gray">{{ t.type }}</span>
              {% endif %}
            </td>
            <td class="{% if t.amount >= 0 %}amount-plus{% else %}amount-minus{% endif %}">
              {% if t.amount >= 0 %}+{% endif %}${{ "%.2f" | format(t.amount | float) }}
            </td>
            <td style="color:#8b949e;">{{ t.description or '‚Äî' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
        <div style="color:#8b949e; font-size:13px;">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –Ω–µ—Ç</div>
      {% endif %}
    </div>

  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<script>
const USER_ID = {{ user.id }};
const LICENSE_KEY = "{{ user.license_key or '' }}";

function toast(msg, isError=false) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = isError ? 'error' : '';
  t.style.display = 'block';
  setTimeout(() => t.style.display = 'none', 3000);
}

async function api(url, body) {
  const r = await fetch(url, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(body)
  });
  return r.json();
}

async function updateEmail() {
  const email = document.getElementById('email-input').value.trim();
  if (!email) return;
  const res = await api('/admin/api/update-email', {user_id: USER_ID, email});
  if (res.success) toast('‚úÖ Email –æ–±–Ω–æ–≤–ª—ë–Ω');
  else toast('‚ùå –û—à–∏–±–∫–∞: ' + (res.detail || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è'), true);
}

async function confirmEmail() {
  const res = await api('/admin/api/confirm-email', {user_id: USER_ID});
  if (res.success) { toast('‚úÖ Email –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω'); setTimeout(() => location.reload(), 1000); }
  else toast('‚ùå –û—à–∏–±–∫–∞: ' + (res.detail || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è'), true);
}

async function resetPassword() {
  const email = document.getElementById('reset-email').value.trim();
  const res = await api('/admin/api/reset-password', {user_id: USER_ID, email});
  if (res.success) toast('üì© –ü–∏—Å—å–º–æ —Å–æ —Å–±—Ä–æ—Å–æ–º –ø–∞—Ä–æ–ª—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
  else toast('‚ùå –û—à–∏–±–∫–∞: ' + (res.detail || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è'), true);
}

async function extendLicense() {
  const days = parseInt(document.getElementById('extend-days').value);
  const res = await api('/admin/api/extend-license', {user_id: USER_ID, days});
  if (res.success) { toast('‚úÖ –õ–∏—Ü–µ–Ω–∑–∏—è –ø—Ä–æ–¥–ª–µ–Ω–∞'); setTimeout(() => location.reload(), 1000); }
  else toast('‚ùå –û—à–∏–±–∫–∞: ' + (res.detail || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è'), true);
}

async function revokeLicense(revoked) {
  if (revoked && !confirm('–û—Ç–æ–∑–≤–∞—Ç—å –ª–∏—Ü–µ–Ω–∑–∏—é? –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ—Ç–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø.')) return;
  const res = await api('/admin/api/revoke-license', {user_id: USER_ID, revoked});
  if (res.success) { toast(revoked ? 'üö´ –õ–∏—Ü–µ–Ω–∑–∏—è –æ—Ç–æ–∑–≤–∞–Ω–∞' : '‚úÖ –õ–∏—Ü–µ–Ω–∑–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞'); setTimeout(() => location.reload(), 1000); }
  else toast('‚ùå –û—à–∏–±–∫–∞: ' + (res.detail || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è'), true);
}

async function addDeposit() {
  const amount = parseFloat(document.getElementById('deposit-amount').value);
  const type = document.getElementById('deposit-type').value;
  const note = document.getElementById('deposit-note').value;
  if (isNaN(amount)) return toast('‚ùå –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É', true);
  
  // –î–ª—è —Å–ø–∏—Å–∞–Ω–∏—è –¥–µ–ª–∞–µ–º –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º
  const finalAmount = (type === 'withdrawal' || type === 'charge') ? -Math.abs(amount) : Math.abs(amount);
  
  const res = await api('/admin/api/add-transaction', {
    user_id: USER_ID,
    amount: finalAmount,
    type,
    description: note || type
  });
  if (res.success) {
    toast('‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞, –±–∞–ª–∞–Ω—Å: $' + res.new_balance.toFixed(2));
    document.getElementById('balance-display').textContent = '$' + res.new_balance.toFixed(2);
    setTimeout(() => location.reload(), 1500);
  } else {
    toast('‚ùå –û—à–∏–±–∫–∞: ' + (res.detail || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è'), true);
  }
}

async function updateDeviceLimit() {
  const limit = parseInt(document.getElementById('device-limit').value);
  if (!LICENSE_KEY) return toast('‚ùå –ù–µ—Ç –ª–∏—Ü–µ–Ω–∑–∏–∏', true);
  const res = await api('/admin/api/update-limit', {key: LICENSE_KEY, max_devices: limit});
  if (res.success) toast('‚úÖ –õ–∏–º–∏—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –æ–±–Ω–æ–≤–ª—ë–Ω');
  else toast('‚ùå –û—à–∏–±–∫–∞: ' + (res.detail || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è'), true);
}

async function unlinkAllDevices() {
  if (!confirm('–û—Ç–≤—è–∑–∞—Ç—å –≤—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞? –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—É–¥–µ—Ç –≤—ã–±—Ä–æ—à–µ–Ω —Å–æ –≤—Å–µ—Ö —Å–µ—Å—Å–∏–π.')) return;
  const res = await api('/admin/api/unlink-devices', {user_id: USER_ID});
  if (res.success) { toast('‚úÖ –°–±—Ä–æ—à–µ–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤: ' + res.count); setTimeout(() => location.reload(), 1000); }
  else toast('‚ùå –û—à–∏–±–∫–∞: ' + (res.detail || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è'), true);
}

async function unlinkDevice(deviceId) {
  const res = await api('/admin/api/unlink-device', {device_id: deviceId});
  if (res.success) {
    toast('‚úÖ –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ—Ç–≤—è–∑–∞–Ω–æ');
    document.getElementById('device-' + deviceId).remove();
  } else {
    toast('‚ùå –û—à–∏–±–∫–∞: ' + (res.detail || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è'), true);
  }
}
</script>
</body>
</html>
