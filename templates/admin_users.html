<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ ‚Äî Admin</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  :root{--bg:#07080a;--surface:#0d0f14;--surface2:#131720;--border:#1c2230;--border2:#252d3d;--text:#e2e8f5;--muted:#5a6580;--muted2:#7a8aa8;--accent:#3b7aff;--accent2:#5c94ff;--green:#22d87a;--red:#ff4e6a;--yellow:#ffb83a;--purple:#9f7aff;--cyan:#22d8d8;--font:'Syne',sans-serif;--mono:'JetBrains Mono',monospace;--sidebar:220px;--radius:14px;--radius-sm:8px;}
  *{margin:0;padding:0;box-sizing:border-box;}
  body{font-family:var(--font);background:var(--bg);color:var(--text);display:flex;min-height:100vh;}
  .sidebar{width:var(--sidebar);min-height:100vh;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;padding:24px 0;position:fixed;left:0;top:0;bottom:0;z-index:100;}
  .logo{padding:0 20px 24px;border-bottom:1px solid var(--border);margin-bottom:16px;}
  .logo-name{font-size:17px;font-weight:800;letter-spacing:-0.5px;color:var(--text);line-height:1;}
  .logo-name span{color:var(--accent2);}
  .logo-sub{font-size:11px;color:var(--muted);margin-top:4px;font-family:var(--mono);text-transform:uppercase;letter-spacing:1px;}
  .nav{flex:1;padding:0 12px;display:flex;flex-direction:column;gap:2px;}
  .nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:var(--radius-sm);color:var(--muted2);text-decoration:none;font-size:14px;font-weight:600;transition:all .15s;position:relative;}
  .nav-item:hover{background:var(--surface2);color:var(--text);}
  .nav-item.active{background:rgba(59,122,255,.12);color:var(--accent2);}
  .nav-item.active::before{content:'';position:absolute;left:0;top:20%;bottom:20%;width:3px;background:var(--accent);border-radius:0 3px 3px 0;}
  .nav-icon{font-size:16px;width:20px;text-align:center;}
  .sidebar-footer{padding:16px 12px 0;border-top:1px solid var(--border);}
  .admin-label{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--muted);padding:8px 12px;font-family:var(--mono);}
  .admin-dot{width:7px;height:7px;background:var(--green);border-radius:50%;}
  .logout-btn{width:100%;background:transparent;border:1px solid var(--border2);color:var(--muted2);padding:9px 12px;border-radius:var(--radius-sm);font-size:13px;font-weight:600;cursor:pointer;font-family:var(--font);transition:all .15s;margin-top:8px;}
  .logout-btn:hover{background:var(--red);border-color:var(--red);color:#fff;}
  .main{margin-left:var(--sidebar);flex:1;min-height:100vh;display:flex;flex-direction:column;}
  .topbar{height:60px;border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 28px;gap:16px;background:var(--surface);position:sticky;top:0;z-index:50;}
  .page-title{font-size:18px;font-weight:800;letter-spacing:-0.5px;}
  .topbar-right{margin-left:auto;display:flex;align-items:center;gap:10px;}
  .content{padding:28px;flex:1;}
  .btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:var(--radius-sm);font-size:12px;font-weight:700;cursor:pointer;border:none;font-family:var(--font);transition:all .15s;text-decoration:none;white-space:nowrap;}
  .btn-primary{background:var(--accent);color:#fff;}
  .btn-primary:hover{background:var(--accent2);}
  .btn-ghost{background:transparent;border:1px solid var(--border2);color:var(--muted2);}
  .btn-ghost:hover{background:var(--surface2);color:var(--text);}
  .btn-danger{background:rgba(255,78,106,.1);color:var(--red);border:1px solid rgba(255,78,106,.2);}
  .btn-danger:hover{background:var(--red);color:#fff;border-color:var(--red);}
  .btn-success{background:rgba(34,216,122,.1);color:var(--green);border:1px solid rgba(34,216,122,.2);}
  .btn-success:hover{background:var(--green);color:#000;}
  .btn-warn{background:rgba(255,184,58,.1);color:var(--yellow);border:1px solid rgba(255,184,58,.2);}
  .btn-warn:hover{background:var(--yellow);color:#000;}
  .btn-sm{padding:5px 10px;font-size:11px;}
  table{width:100%;border-collapse:collapse;font-size:13px;}
  .table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;}
  thead th{background:var(--surface2);padding:10px 16px;text-align:left;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--muted);font-family:var(--mono);border-bottom:1px solid var(--border);white-space:nowrap;}
  tbody tr{border-bottom:1px solid var(--border);transition:background .1s;}
  tbody tr:last-child{border-bottom:none;}
  tbody tr:hover{background:rgba(19,23,32,.7);}
  tbody td{padding:11px 16px;vertical-align:middle;}
  .mono{font-family:var(--mono);font-size:12px;}
  .text-muted{color:var(--muted2);}
  .badge{display:inline-flex;align-items:center;gap:5px;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:600;font-family:var(--mono);white-space:nowrap;}
  .badge::before{content:'';width:5px;height:5px;border-radius:50%;}
  .badge-green{background:rgba(34,216,122,.1);color:var(--green);border:1px solid rgba(34,216,122,.2);}
  .badge-green::before{background:var(--green);}
  .badge-red{background:rgba(255,78,106,.1);color:var(--red);border:1px solid rgba(255,78,106,.2);}
  .badge-red::before{background:var(--red);}
  .badge-yellow{background:rgba(255,184,58,.1);color:var(--yellow);border:1px solid rgba(255,184,58,.2);}
  .badge-yellow::before{background:var(--yellow);}
  .badge-blue{background:rgba(59,122,255,.1);color:var(--accent2);border:1px solid rgba(59,122,255,.2);}
  .badge-blue::before{background:var(--accent);}
  .key-chip{font-family:var(--mono);font-size:11px;background:var(--surface2);border:1px solid var(--border2);border-radius:5px;padding:2px 7px;color:var(--accent2);}
  .copy-btn{background:none;border:none;cursor:pointer;color:var(--muted);font-size:12px;padding:2px 4px;border-radius:4px;transition:color .15s;}
  .copy-btn:hover{color:var(--accent2);}
  .action-bar{display:flex;align-items:center;gap:10px;margin-bottom:14px;flex-wrap:wrap;}
  .search-wrap{position:relative;flex:1;max-width:300px;}
  .search-icon{position:absolute;left:11px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:13px;pointer-events:none;}
  .search-input{background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);padding:8px 12px 8px 34px;color:var(--text);font-size:13px;font-family:var(--font);outline:none;width:100%;transition:border-color .15s;}
  .search-input:focus{border-color:var(--accent);}
  .search-input::placeholder{color:var(--muted);}
  .filter-tabs{display:flex;gap:3px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:3px;}
  .filter-tab{padding:5px 11px;border-radius:5px;font-size:12px;font-weight:700;cursor:pointer;color:var(--muted2);border:none;background:transparent;font-family:var(--font);transition:all .15s;}
  .filter-tab:hover{color:var(--text);}
  .filter-tab.active{background:var(--surface);color:var(--text);box-shadow:0 1px 3px rgba(0,0,0,.3);}
  .modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);z-index:1000;align-items:center;justify-content:center;}
  .modal-bg.open{display:flex;}
  .modal{background:var(--surface);border:1px solid var(--border2);border-radius:var(--radius);padding:28px;width:400px;max-width:95vw;animation:slideUp .2s ease;}
  @keyframes slideUp{from{opacity:0;transform:translateY(16px);}to{opacity:1;transform:translateY(0);}}
  .modal-title{font-size:16px;font-weight:800;margin-bottom:6px;}
  .modal-sub{font-size:13px;color:var(--muted2);margin-bottom:20px;word-break:break-all;}
  .modal-footer{display:flex;gap:10px;justify-content:flex-end;margin-top:20px;}
  .toast-wrap{position:fixed;bottom:24px;right:24px;z-index:2000;display:flex;flex-direction:column;gap:8px;}
  .toast{background:var(--surface);border:1px solid var(--border2);border-radius:var(--radius-sm);padding:12px 16px;font-size:13px;font-weight:600;display:flex;align-items:center;gap:8px;animation:toastIn .2s ease;min-width:240px;box-shadow:0 8px 24px rgba(0,0,0,.4);}
  .toast.ok{border-color:rgba(34,216,122,.3);}
  .toast.err{border-color:rgba(255,78,106,.3);}
  @keyframes toastIn{from{opacity:0;transform:translateX(16px);}to{opacity:1;transform:translateX(0);}}
  ::-webkit-scrollbar{width:6px;}::-webkit-scrollbar-track{background:transparent;}::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px;}
  .row-actions{display:flex;gap:5px;flex-wrap:wrap;align-items:center;}
  .email-cell{display:flex;align-items:center;gap:6px;}
  .avatar{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--purple));display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;color:#fff;flex-shrink:0;}
  .balance-val{font-family:var(--mono);font-size:13px;font-weight:700;color:var(--green);}
  .balance-val.zero{color:var(--muted);}
  .form-group{display:flex;flex-direction:column;gap:5px;}
  .form-label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--muted);font-family:var(--mono);}
  .form-input{background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);padding:10px 14px;color:var(--text);font-size:13px;font-family:var(--font);outline:none;transition:border-color .15s;width:100%;}
  .form-input:focus{border-color:var(--accent);}
</style>
</head>
<body>

<div class="sidebar">
  <div class="logo">
    <div class="logo-name"><span>TG</span> Parser Sender</div>
    <div class="logo-sub">Admin Panel</div>
  </div>
  <nav class="nav">
    <a href="/admin" class="nav-item {% if active_tab == 'dashboard' %}active{% endif %}"><span class="nav-icon">‚óà</span> –î–∞—à–±–æ—Ä–¥</a>
    <a href="/admin/licenses" class="nav-item {% if active_tab == 'licenses' %}active{% endif %}"><span class="nav-icon">‚åó</span> –õ–∏—Ü–µ–Ω–∑–∏–∏</a>
    <a href="/admin/users" class="nav-item {% if active_tab == 'users' %}active{% endif %}"><span class="nav-icon">‚óâ</span> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
    <a href="/admin/devices" class="nav-item {% if active_tab == 'devices' %}active{% endif %}"><span class="nav-icon">‚äü</span> –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</a>
    <a href="/admin/transactions" class="nav-item {% if active_tab == 'transactions' %}active{% endif %}"><span class="nav-icon">‚âã</span> –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</a>
    <a href="/admin/settings" class="nav-item {% if active_tab == 'settings' %}active{% endif %}"><span class="nav-icon">‚åò</span> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
  </nav>
  <div class="sidebar-footer">
    <div class="admin-label"><span class="admin-dot"></span>admin online</div>
    <form method="post" action="/admin/logout"><button class="logout-btn" type="submit">‚Ü© –í—ã–π—Ç–∏</button></form>
  </div>
</div>

<div class="main">
  <div class="topbar">
    <span class="page-title">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</span>
    <div class="topbar-right">
      <span class="mono text-muted" style="font-size:12px;">{{ users|length }} –∑–∞–ø–∏—Å–µ–π</span>
    </div>
  </div>
  <div class="content">

    <div class="action-bar">
      <div class="search-wrap">
        <span class="search-icon">‚åï</span>
        <input class="search-input" placeholder="Email, –∫–ª—é—á..." oninput="filterTable(this.value)">
      </div>
      <div class="filter-tabs">
        <button class="filter-tab active" onclick="setFilter('all',this)">–í—Å–µ</button>
        <button class="filter-tab" onclick="setFilter('confirmed',this)">Email ‚úì</button>
        <button class="filter-tab" onclick="setFilter('unconfirmed',this)">Email ‚úó</button>
      </div>
    </div>

    <div class="table-wrap">
      <table id="usersTable">
        <thead>
          <tr>
            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
            <th>–õ–∏—Ü–µ–Ω–∑–∏—è</th>
            <th>–ë–∞–ª–∞–Ω—Å</th>
            <th>Email</th>
            <th>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω</th>
            <th>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody>
          {% for u in users %}
          <tr data-confirmed="{{ 'yes' if u.email_confirmed else 'no' }}">
            <td>
              <div class="email-cell">
                <div class="avatar">{{ u.email[0].upper() }}</div>
                <div>
                  <div style="font-size:13px;font-weight:600;">{{ u.email }}</div>
                  <div style="font-size:11px;color:var(--muted);font-family:var(--mono);">#{{ u.id }}</div>
                </div>
                <button class="copy-btn" onclick="copyText('{{ u.email }}')">‚éò</button>
              </div>
            </td>
            <td>
              {% if u.license_key %}
                <span class="key-chip">{{ u.license_key }}</span>
                <button class="copy-btn" onclick="copyText('{{ u.license_key }}')">‚éò</button>
              {% else %}
                <span style="color:var(--muted)">‚Äî</span>
              {% endif %}
            </td>
            <td>
              <span class="balance-val {% if not u.balance or u.balance == 0 %}zero{% endif %}">
                ${{ "%.2f"|format(u.balance or 0) }}
              </span>
            </td>
            <td>
              {% if u.email_confirmed %}
                <span class="badge badge-green">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω</span>
              {% else %}
                <span class="badge badge-yellow">–ù–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω</span>
              {% endif %}
            </td>
            <td><span class="mono text-muted">{{ u.created_at.strftime('%d.%m.%y %H:%M') if u.created_at else '‚Äî' }}</span></td>
            <td><span class="mono text-muted">{{ u.last_login.strftime('%d.%m.%y %H:%M') if u.last_login else '‚Äî' }}</span></td>
            <td>
              <div class="row-actions">
                <a href="/admin/user/{{ u.id }}" class="btn btn-primary btn-sm">‚Üí –û—Ç–∫—Ä—ã—Ç—å</a>
                <button class="btn btn-ghost btn-sm" onclick="openBalance({{ u.id }}, '{{ u.email }}', {{ u.balance or 0 }})">üí∞</button>
                <button class="btn btn-danger btn-sm" onclick="unlinkDevices({{ u.id }}, '{{ u.email }}')">üìµ</button>
              </div>
            </td>
          </tr>
          {% else %}
          <tr><td colspan="7" style="padding:40px;text-align:center;color:var(--muted);">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ—Ç</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- BALANCE MODAL -->
<div class="modal-bg" id="balanceModal">
  <div class="modal">
    <div class="modal-title">üí∞ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–º</div>
    <div class="modal-sub" id="balanceEmail">‚Äî</div>
    <div class="form-group" style="margin-bottom:14px;">
      <label class="form-label">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</label>
      <div class="form-input" id="currentBal" style="color:var(--green);font-family:var(--mono);font-weight:700;">$0.00</div>
    </div>
    <div class="form-group">
      <label class="form-label">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å ($)</label>
      <input type="number" class="form-input" id="newBalance" step="0.01" min="0" placeholder="0.00">
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('balanceModal')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" onclick="saveBalance()">‚úì –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- RESET PWD MODAL -->
<div class="modal-bg" id="resetModal">
  <div class="modal">
    <div class="modal-title">üîë –°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è</div>
    <div class="modal-sub" id="resetEmail">‚Äî</div>
    <p style="font-size:13px;color:var(--muted2);margin-bottom:20px;">–ë—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–∏—Å—å–º–æ —Å–æ —Å—Å—ã–ª–∫–æ–π –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è.</p>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('resetModal')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-warn" onclick="doReset()">üìß –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ</button>
    </div>
  </div>
</div>

<div class="toast-wrap" id="toasts"></div>

<script>
  let currentUserId = null;

  // ===== FILTER =====
  let currentFilter = 'all', currentSearch = '';
  function setFilter(f, el) {
    currentFilter = f;
    document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    applyFilter();
  }
  function filterTable(q) { currentSearch = q.toLowerCase(); applyFilter(); }
  function applyFilter() {
    document.querySelectorAll('#usersTable tbody tr[data-confirmed]').forEach(r => {
      const confirmed = r.dataset.confirmed;
      const text = r.textContent.toLowerCase();
      const mf = currentFilter === 'all' || (currentFilter === 'confirmed' && confirmed === 'yes') || (currentFilter === 'unconfirmed' && confirmed === 'no');
      const ms = !currentSearch || text.includes(currentSearch);
      r.style.display = (mf && ms) ? '' : 'none';
    });
  }

  // ===== BALANCE =====
  function openBalance(id, email, balance) {
    currentUserId = id;
    document.getElementById('balanceEmail').textContent = email;
    document.getElementById('currentBal').textContent = '$' + parseFloat(balance).toFixed(2);
    document.getElementById('newBalance').value = parseFloat(balance).toFixed(2);
    document.getElementById('balanceModal').classList.add('open');
  }
  async function saveBalance() {
    const amount = parseFloat(document.getElementById('newBalance').value);
    if (isNaN(amount)) return showToast('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É', 'err');
    try {
      const res = await fetch('/admin/api/set-balance', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ user_id: currentUserId, balance: amount })
      });
      const d = await res.json();
      if (d.success) { showToast('‚úì –ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª—ë–Ω: $' + amount.toFixed(2), 'ok'); closeModal('balanceModal'); setTimeout(()=>location.reload(), 800); }
      else showToast('–û—à–∏–±–∫–∞: ' + (d.error||'?'), 'err');
    } catch(e) { showToast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'err'); }
  }

  // ===== RESET PWD =====
  function openResetPwd(id, email) {
    currentUserId = id;
    document.getElementById('resetEmail').textContent = email;
    document.getElementById('resetModal').classList.add('open');
  }
  async function doReset() {
    try {
      const email = document.getElementById('resetEmail').textContent;
      const res = await fetch('/admin/api/reset-password', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ user_id: currentUserId, email })
      });
      const d = await res.json();
      if (d.success) { showToast('üìß –ü–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'ok'); closeModal('resetModal'); }
      else showToast('–û—à–∏–±–∫–∞: ' + (d.error||'?'), 'err');
    } catch(e) { showToast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'err'); }
  }

  // ===== UNLINK DEVICES =====
  async function unlinkDevices(id, email) {
    if (!confirm('–û—Ç–≤—è–∑–∞—Ç—å –≤—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ' + email + '?\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—É–¥–µ—Ç –≤—ã–±—Ä–æ—à–µ–Ω —Å–æ –≤—Å–µ—Ö —Å–µ—Å—Å–∏–π.')) return;
    try {
      const res = await fetch('/admin/api/unlink-devices', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ user_id: id })
      });
      const d = await res.json();
      if (d.success) showToast('‚úì –û—Ç–≤—è–∑–∞–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤: ' + d.count, 'ok');
      else showToast('–û—à–∏–±–∫–∞: ' + (d.error||'?'), 'err');
    } catch(e) { showToast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'err'); }
  }

  // ===== MODAL =====
  function closeModal(id) { document.getElementById(id).classList.remove('open'); }
  document.querySelectorAll('.modal-bg').forEach(m => m.addEventListener('click', function(e){ if(e.target===this) this.classList.remove('open'); }));

  // ===== COPY & TOAST =====
  function copyText(t) { navigator.clipboard.writeText(t).then(()=>showToast('‚éò ' + t, 'ok')); }
  function showToast(msg, type='ok') {
    const w = document.getElementById('toasts');
    const t = document.createElement('div');
    t.className = 'toast ' + type;
    t.textContent = msg;
    w.appendChild(t);
    setTimeout(()=>t.remove(), 3000);
  }
</script>
</body>
</html>
